# ECHO-BUG-017: 服务器地址硬编码导致真机无法连接

## 变更概述

- **变更 ID**: ECHO-BUG-017
- **变更类型**: Bug 修复
- **优先级**: 高
- **开发者**: AI Agent
- **开发日期**: 2026-02-01
- **上游版本基线**: Telegram v10.5.2
- **状态**: ✅ 已完成

## 问题描述

### 用户故事
作为开发者，我希望 Android 真机能够连接到 Mac 上运行的 Echo 服务器，以便进行真机测试。

### 问题现象
- Android 真机无法连接到 Echo 服务器
- 客户端一直显示 "Connecting..."
- 无法获取验证码
- 抓包显示 TCP 连接尝试连接到 `127.0.0.1:10443`

### 根本原因
服务器地址在 `ConnectionsManager.cpp` 中硬编码为 `127.0.0.1:10443`，真机无法访问 Mac 的 localhost。

## 技术实现

### 修改的文件清单

#### 1. ConnectionsManager.cpp
**路径**: `echo-android-client/TMessagesProj/jni/tgnet/ConnectionsManager.cpp`

**修改位置**:
- 行号: 2598, 2599, 2600, 2601, 2602, 2603, 2604, 2605
- 变更内容: 将 8 处 `127.0.0.1` 替换为 Mac 局域网 IP `192.168.0.17`
- 变更原因: 允许真机通过局域网访问 Mac 上的 Echo 服务器

**修改前**:
```cpp
"127.0.0.1", 10443,
"127.0.0.1", 10443,
"127.0.0.1", 10443,
"127.0.0.1", 10443,
"127.0.0.1", 10443,
"127.0.0.1", 10443,
"127.0.0.1", 10443,
"127.0.0.1", 10443,
```

**修改后**:
```cpp
"192.168.0.17", 10443,
"192.168.0.17", 10443,
"192.168.0.17", 10443,
"192.168.0.17", 10443,
"192.168.0.17", 10443,
"192.168.0.17", 10443,
"192.168.0.17", 10443,
"192.168.0.17", 10443,
```

#### 2. 新增工具脚本

**文件**: `echo-android-client/update-server-ip.sh`
- 功能: 自动更新 ConnectionsManager.cpp 中的服务器 IP 地址
- 用法: `./update-server-ip.sh <new_ip>`

**文件**: `echo-android-client/configure-server.sh`
- 功能: 交互式配置服务器地址
- 用法: `./configure-server.sh`

## 测试验证

### 测试步骤
1. 修改 ConnectionsManager.cpp 中的服务器地址
2. 重新编译 Native 库：`./gradlew TMessagesProj:assembleAfatDebug`
3. 安装 APK 到真机
4. 启动应用，输入手机号
5. 使用 Wireshark 抓包验证连接地址

### 测试结果
✅ TCP 连接成功建立到 `192.168.0.17:10443`
✅ 客户端能够正常发送请求
✅ 服务器能够正常响应

## 上游兼容性分析

### 冲突风险评估
- **风险等级**: 低
- **潜在冲突点**: 
  - `ConnectionsManager.cpp` 的服务器地址配置可能与上游更新冲突
  - 如果 Telegram 官方修改了服务器地址的存储方式，需要重新适配

### 合并策略
- **隔离方案**: 
  - 服务器地址配置独立于其他逻辑
  - 使用脚本自动化更新，减少手动修改
  
- **回滚方案**:
  - 恢复原始的 `127.0.0.1` 地址
  - 或者使用 Git 回退到修改前的版本

### 上游更新适配指南
当 Telegram 官方更新时：
1. 检查 `ConnectionsManager.cpp` 中服务器地址相关代码是否变更
2. 如有冲突，重新应用服务器地址修改
3. 更新 `update-server-ip.sh` 脚本以适配新的代码结构
4. 运行测试验证连接正常

## 回滚计划

### 回滚步骤
1. 恢复 `ConnectionsManager.cpp` 中的服务器地址为 `127.0.0.1`
2. 重新编译 Native 库
3. 重新安装 APK

### 数据保留策略
- 无需数据迁移
- 配置变更不影响用户数据

## 相关问题

### 关联 Bug
- ECHO-BUG-018: RSA 公钥不匹配（后续问题）
- ECHO-BUG-019: DH 密钥交换失败（后续问题）

### 参考文档
- [ECHO-BUG-013-快速参考.md](../../ECHO-BUG-013-快速参考.md)
- [配置本地服务器.md](../../配置本地服务器.md)

## 备注

### 开发环境配置
- Mac 局域网 IP: `192.168.0.17`
- Echo 服务器端口: `10443`
- 测试设备: Huawei 真机

### 已知限制
- 服务器 IP 地址硬编码，每次 Mac IP 变化需要重新编译
- 未来可考虑实现动态配置服务器地址的功能

### 改进建议
1. 实现服务器地址的动态配置（通过配置文件或环境变量）
2. 添加服务器地址的运行时切换功能
3. 支持多个服务器地址的负载均衡
