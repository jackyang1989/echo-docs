# Echo Server Go 编码规范

本规范适用于 `echo-server` 服务端代码。目标：**长期可维护、状态正确、可验证一致性**。

本文件是工程落地规范，权威约束以以下文档为准：

- 项目宪法：`/Users/jianouyang/Project/echo/AGENTS.md`
- 权威约束清单：`/Users/jianouyang/Project/echo/echo-docs/docs/planning/ECHO_AUTHORITY_CONSTRAINTS.md`
- 执行方案：
  - Week 1-8：`/Users/jianouyang/Project/echo/ECHO执行方案-精简版.md`
  - Week 9-36：`/Users/jianouyang/Project/echo/ECHO_DEVELOPMENT_PLAN_V2.md`

## 1. 核心原则

- **正确性 > 完整性 > 性能 > 开发速度**
- 不允许临时 workaround、mock/fake、吞错或假成功
- 所有状态必须可回放、可验证、一致性可证明
- 代码必须是最终形态，不留试验痕迹

## 2. 包结构与依赖

- 模块边界清晰：禁止跨层直接访问内部实现
- 依赖方向单向：上层依赖下层，不允许循环依赖
- `internal/` 仅供内部使用，严禁跨模块滥用
- 领域/协议/存储分离：
  - 协议编解码（MTProto）只负责“字节/结构体”，不承载业务状态机
  - 业务状态机只依赖抽象存储接口，不直接依赖具体 SQL 细节

## 3. 配置与启动（P0 规则）

- `cmd/*/main.go` 只做：解析 flags/env → 读取 `configs/*.yaml` → `Validate()` → 启动服务
- 禁止硬编码 DB/端口/RSAKey/DC 地址
- 缺失必填项必须 **fail-fast** 退出
- 配置必须单一事实源（SSOT）：以 `configs/*.yaml` 为准；允许通过环境变量覆盖“配置路径”，不允许覆盖业务字段导致不可追踪漂移

## 4. 错误处理

- 禁止吞掉错误或返回假成功
- 错误必须带上下文信息（使用 `fmt.Errorf("...: %w", err)`）
- 可判定错误必须通过显式错误码/类型传递，便于调用方处理
- 可恢复错误必须可定位：日志 + 指标（见第 12 节）应足够让值班在不读代码的情况下判断影响范围
- “不可恢复错误”要快速失败：panic 只允许用于“不可继续且会污染状态”的场景，并且必须有明确日志字段

## 5. 日志规范

- 使用结构化日志（字段清晰、可检索）
- 禁止输出敏感信息（密钥、密码、验证码）
- 关键链路必须有可追踪日志（Auth/Sync/Message/Session）
- 日志必须可串联：必须包含至少一个稳定关联键（如 `auth_key_id`/`user_id`/`session_id`/`req_msg_id`），禁止只打自然语言

## 6. 并发与资源

- goroutine 必须可控：有退出条件或受 `context` 管理
- 禁止泄漏（无限 goroutine / 无上限 channel）
- 锁使用必须有注释说明“为什么必须加锁”
- I/O 必须有超时：网络、数据库、RPC 全部使用 `context.WithTimeout`
- 不允许“后台无限重试”掩盖失败；重试必须是有界、可观测、可告警的

## 7. 数据库与一致性

- 事务边界清晰：保证状态变更原子性
- 任何涉及 pts/seq/updates 的变更必须单调、可回放
- 禁止无约束 upsert 或隐式覆盖导致状态腐烂
- 所有写路径必须满足：
  - 幂等性可证明（基于唯一键/去重键）
  - 失败可重试且不会产生重复可见副作用
- Schema 变更必须：
  - 有向前/向后兼容策略
  - 有迁移脚本与回滚策略
  - 有对应的变更记录（见第 13 节）

## 8. 接口与协议

- MTProto/gRPC 返回必须遵循协议语义，禁止“兜底成功”
- 未实现功能必须返回明确错误（`NOT_IMPLEMENTED`）
- 未授权请求必须返回明确错误（如 `AUTH_KEY_UNREGISTERED`），但不得造成客户端无限重试死循环：
  - 需要配合协议语义返回“能促使客户端进入正确状态”的错误类型
  - 必须在服务端日志中记录触发条件与上下文键

## 9. 注释规则

- 只允许两类注释：**设计原因**、**协议/业务约束**
- 禁止注释掉代码、禁止使用未完成标记（如 FIXME）作为未完成逻辑

## 10. 变更记录

- 任何服务端变更必须同步记录到 `echo-docs/echo-server/docs/core/changes/`
- 必须更新 `CHANGELOG.md` 中的 `[Unreleased]`

## 11. 命名与可读性

- 名称要表达业务含义：避免 `data1`/`tmp`/`doStuff`
- 缩写必须行业通用且在本项目语境明确（如 `pts/seq/qts`）
- 导出符号（public）要谨慎：能不导出就不导出，避免不受控耦合

## 12. 测试与可验证性（强制）

- 任何影响状态一致性的逻辑必须可测试：
  - 单元测试：纯函数/状态机/存储接口的行为
  - 集成测试：关键链路（登录、会话、多设备、updates 差量同步）
- 测试必须验证“正确性”，而不是验证“没有报错”
- 回归测试优先级高于新功能：同类问题不得重复出现

## 13. 可观测性（日志/指标/告警）

- 关键入口必须有指标（至少：成功数、失败数、延迟分布）
- 对外错误必须可聚合：以错误码为维度统计
- 对外 SLO 相关链路（登录、拉取对话、发消息、getDifference）必须有独立指标

## 14. 代码格式与静态检查

- Go 代码必须 `gofmt`；禁止引入仅为“个人喜好”的风格分歧
- 变更必须通过 `go test ./...`（如仓库当前已具备测试）
- 引入新依赖要谨慎：必须说明必要性与替代方案

## 15. 安全与隐私

- 禁止记录验证码、密码、私钥、明文 token
- 任何和认证相关的“临时放宽”都视为 P0 风险，必须拒绝
