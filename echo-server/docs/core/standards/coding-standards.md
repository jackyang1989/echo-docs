# Echo Server Go 编码规范

本规范适用于 `echo-server` 服务端代码。目标：**长期可维护、状态正确、可验证一致性**。所有实现必须遵守项目宪法与权威约束清单。

## 1. 核心原则

- **正确性 > 完整性 > 性能 > 开发速度**
- 不允许临时 workaround、mock/fake、吞错或假成功
- 所有状态必须可回放、可验证、一致性可证明
- 代码必须是最终形态，不留试验痕迹

## 2. 包结构与依赖

- 模块边界清晰：禁止跨层直接访问内部实现
- 依赖方向单向：上层依赖下层，不允许循环依赖
- `internal/` 仅供内部使用，严禁跨模块滥用

## 3. 配置与启动（P0 规则）

- `cmd/*/main.go` 只做：解析 flags/env → 读取 `configs/*.yaml` → `Validate()` → 启动服务
- 禁止硬编码 DB/端口/RSAKey/DC 地址
- 缺失必填项必须 **fail-fast** 退出

## 4. 错误处理

- 禁止吞掉错误或返回假成功
- 错误必须带上下文信息（使用 `fmt.Errorf("...: %w", err)`）
- 可判定错误必须通过显式错误码/类型传递，便于调用方处理

## 5. 日志规范

- 使用结构化日志（字段清晰、可检索）
- 禁止输出敏感信息（密钥、密码、验证码）
- 关键链路必须有可追踪日志（Auth/Sync/Message/Session）

## 6. 并发与资源

- goroutine 必须可控：有退出条件或受 `context` 管理
- 禁止泄漏（无限 goroutine / 无上限 channel）
- 锁使用必须有注释说明“为什么必须加锁”

## 7. 数据库与一致性

- 事务边界清晰：保证状态变更原子性
- 任何涉及 pts/seq/updates 的变更必须单调、可回放
- 禁止无约束 upsert 或隐式覆盖导致状态腐烂

## 8. 接口与协议

- MTProto/gRPC 返回必须遵循协议语义，禁止“兜底成功”
- 未实现功能必须返回明确错误（`NOT_IMPLEMENTED`）

## 9. 注释规则

- 只允许两类注释：**设计原因**、**协议/业务约束**
- 禁止注释掉代码、禁止 TODO/FIXME 作为未完成逻辑

## 10. 变更记录

- 任何服务端变更必须同步记录到 `echo-docs/echo-server/docs/core/changes/`
- 必须更新 `CHANGELOG.md` 中的 `[Unreleased]`

