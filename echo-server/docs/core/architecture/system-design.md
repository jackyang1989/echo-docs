# Echo Server 系统架构设计

**文档版本**: 1.0.0  
**创建日期**: 2026-02-03  
**维护者**: Echo 项目团队  
**文档级别**: 🔴 核心文档（禁止删除）

---

## 📋 文档说明

本文档描述 Echo Server 的整体系统架构设计，包括：
- 自研架构模型
- 服务划分与职责
- 数据流转机制
- 服务间通信方式
- 与 Teamgram Gateway 的集成方式

---

## 🎯 架构定位

### Echo Server 是什么？

**Echo Server 是 100% 自研的 IM 服务端**，核心特点：

- ✅ **100% 自研业务层**：Auth、User、Message、Sync 等核心服务完全自研
- ✅ **复用 Teamgram Gateway**：仅用于处理 MTProto 协议层
- ✅ **对齐 MTProto 协议**：遵循 Telegram 官方协议规范
- ✅ **对齐客户端期望**：确保与 Telegram 官方客户端兼容

### Echo Server 不是什么？

- ❌ **不是 Teamgram 的 fork**：业务层完全自研，不依赖 Teamgram 实现
- ❌ **不对齐 Teamgram 实现**：只参考其 MTProto 实现，不复制其业务逻辑
- ❌ **不是简单的二次开发**：是基于协议规范的全新实现

---

## 🏗️ 整体架构

### 架构分层

```
┌─────────────────────────────────────────────────────────────┐
│                    Telegram 官方客户端                        │
│              (echo-android-client / iOS / Web)              │
└─────────────────────────────────────────────────────────────┘
                            ↓ MTProto
┌─────────────────────────────────────────────────────────────┐
│                   Teamgram Gateway (复用)                    │
│              - MTProto 协议处理                              │
│              - 加密/解密                                     │
│              - 会话管理                                      │
└─────────────────────────────────────────────────────────────┘
                            ↓ gRPC
┌─────────────────────────────────────────────────────────────┐
│                    Echo BFF (自研)                           │
│              - API 路由                                      │
│              - 请求聚合                                      │
│              - 权限校验                                      │
└─────────────────────────────────────────────────────────────┘
                            ↓ gRPC
┌─────────────────────────────────────────────────────────────┐
│                  Echo 核心服务层 (100% 自研)                 │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │  Auth    │  │  User    │  │ Message  │  │  Sync    │   │
│  │  Service │  │  Service │  │ Service  │  │ Service  │   │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                      数据存储层                              │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │ MySQL    │  │  Redis   │  │  Kafka   │  │  MinIO   │   │
│  │ (主存储) │  │ (缓存)   │  │ (消息队列)│  │ (媒体)   │   │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │
└─────────────────────────────────────────────────────────────┘
```

---

## 🔧 核心服务设计

### 1. Gateway (复用 Teamgram)

**职责**：
- MTProto 协议处理（加密/解密）
- 会话管理（Session）
- 连接管理（长连接）
- 协议层路由

**为什么复用？**
- MTProto 协议复杂，实现成本高
- Teamgram Gateway 实现成熟稳定
- 专注业务层创新，不重复造轮子

**集成方式**：
- Gateway 作为独立服务运行
- 通过 gRPC 与 BFF 通信
- 不修改 Gateway 代码，只配置

---

### 2. BFF (Backend For Frontend) - 自研

**职责**：
- API 路由和聚合
- 请求参数验证
- 权限校验（Feature Flag、用户白名单）
- 响应格式化

**设计原则**：
- 轻量级，不包含业务逻辑
- 可水平扩展
- 支持多客户端（Android、iOS、Web）

**技术栈**：
- Go + gRPC
- 无状态设计
- 支持负载均衡

---

### 3. Auth Service - 自研

**职责**：
- 用户注册（手机号/邮箱）
- 登录认证（验证码/密码）
- Token 管理（生成/验证/刷新）
- 设备管理（多设备登录）

**核心流程**：
```
1. 客户端请求验证码
   ↓
2. Auth Service 生成验证码
   ↓
3. 发送验证码（短信/邮件）
   ↓
4. 客户端提交验证码
   ↓
5. Auth Service 验证并生成 Token
   ↓
6. 返回 Token 给客户端
```

**数据模型**：
- `users` 表：用户基本信息
- `auth_sessions` 表：登录会话
- `auth_codes` 表：验证码记录
- `devices` 表：设备信息

---

### 4. User Service - 自研

**职责**：
- 用户资料管理（昵称、头像、简介）
- 联系人管理（添加/删除/搜索）
- 隐私设置（谁可以看我、谁可以联系我）
- 黑名单管理

**核心功能**：
- 用户信息 CRUD
- 联系人关系维护
- 隐私策略执行
- 用户搜索（支持手机号/用户名）

**数据模型**：
- `users` 表：用户信息
- `contacts` 表：联系人关系
- `privacy_settings` 表：隐私设置
- `blocked_users` 表：黑名单

---

### 5. Message Service - 自研

**职责**：
- 消息发送（文本/图片/视频/文件）
- 消息存储（持久化）
- 消息投递（单聊/群聊）
- 消息状态管理（已发送/已送达/已读）

**核心流程**：
```
1. 客户端发送消息
   ↓
2. Message Service 接收并验证
   ↓
3. 分配 message_id 和 pts
   ↓
4. 写入 messages 表
   ↓
5. 写入 update_log 表
   ↓
6. 通过 Kafka 通知 Sync Service
   ↓
7. Sync Service 推送给接收方
```

**数据模型**：
- `messages` 表：消息内容
- `dialogs` 表：会话列表
- `update_log` 表：更新日志（pts 序列）
- `files` 表：媒体文件元数据

---

### 6. Sync Service - 自研

**职责**：
- 消息同步（getDifference）
- 更新推送（updates）
- pts/qts/seq 管理
- 多设备同步

**核心机制**：
```
客户端维护 pts（per-dialog sequence）
  ↓
定期调用 getDifference(pts)
  ↓
Sync Service 查询 update_log
  ↓
返回 pts 之后的所有更新
  ↓
客户端应用更新并更新本地 pts
```

**数据模型**：
- `update_log` 表：更新日志
- `pts_state` 表：pts 状态
- `sync_queue` 表：同步队列

---

## 📊 数据流转

### 消息发送流程

```
1. 客户端 → Gateway (MTProto)
   - 加密消息
   - 会话验证

2. Gateway → BFF (gRPC)
   - 解密消息
   - 转换为内部格式

3. BFF → Message Service (gRPC)
   - 路由到消息服务
   - 权限校验

4. Message Service → MySQL
   - 写入 messages 表
   - 写入 update_log 表
   - 分配 pts

5. Message Service → Kafka
   - 发布消息事件
   - 触发同步流程

6. Kafka → Sync Service
   - 消费消息事件
   - 推送给接收方

7. Sync Service → Gateway (gRPC)
   - 构造 updates
   - 推送给客户端

8. Gateway → 客户端 (MTProto)
   - 加密 updates
   - 推送到设备
```

---

## 🔄 服务间通信

### 通信方式

| 场景 | 通信方式 | 说明 |
|------|---------|------|
| 客户端 ↔ Gateway | MTProto (TCP/WebSocket) | 加密长连接 |
| Gateway ↔ BFF | gRPC | 同步调用 |
| BFF ↔ 核心服务 | gRPC | 同步调用 |
| 服务间事件 | Kafka | 异步消息 |
| 缓存访问 | Redis | 直接访问 |
| 数据库访问 | MySQL | 直接访问 |

### 服务发现

- 使用 Consul / Etcd 进行服务注册与发现
- 支持动态扩缩容
- 健康检查与自动摘除

---

## 🛡️ 架构原则

### 1. IM 内核不可污染（Hard Rule）

**IM 内核**（Auth、User、Message、Sync）**只允许**承担协议级职责：
- ✅ 协议级会话管理
- ✅ 消息投递与同步
- ✅ 群/频道的协议行为
- ✅ 媒体的协议级处理

**IM 内核严禁**直接依赖业务模块：
- ❌ 邮箱/短信注册
- ❌ 邀请码/白名单
- ❌ 广场/信息流/推荐
- ❌ 广告/商业化
- ❌ 运营配置/A/B 实验

---

### 2. 单向依赖原则（Hard Rule）

**业务模块对 IM 的访问权限**：
- ✅ 读取 IM 事件
- ✅ 读取 IM 的只读视图或副本
- ❌ 直接写入 IM 的核心消息表
- ❌ 直接写入 IM 的会话/投递链路表

**影响 IM 状态的受控方式**：
- 必须通过明确的「管理操作 API」
- 必须具备权限校验和审计记录

---

### 3. 可降级与功能开关（Hard Rule）

**任何新增功能必须**：
- 拥有独立 Feature Flag Key
- 默认状态为「关闭」
- 支持全局开关、用户白名单、客户端版本控制

**功能关闭后**：
- UI 入口必须隐藏或不可交互
- API 必须返回明确的降级态
- IM 聊天、消息同步必须完全不受影响

---

### 4. 契约与版本化（Hard Rule）

**IM 事件命名必须包含版本号**：
```
✅ 正确：
im.message.created.v1
im.chat.updated.v1
```

**升级 Gateway / IM Core 的兼容流程**：
1. 保证现有 v1 事件/接口保持不变
2. 新能力以 v2 形式引入
3. v1 / v2 并行运行一段时间
4. 业务侧完成迁移后，方可下线 v1

---

## 🔐 安全设计

### 认证与授权

- **Token 机制**：JWT Token，包含用户 ID、设备 ID、过期时间
- **多设备支持**：每个设备独立 Token，支持单独撤销
- **权限校验**：基于角色的访问控制（RBAC）

### 数据加密

- **传输加密**：MTProto 端到端加密
- **存储加密**：敏感数据（如密码）使用 bcrypt 加密
- **媒体加密**：可选的端到端加密媒体文件

---

## 📈 性能优化

### 缓存策略

- **用户信息缓存**：Redis，TTL 1 小时
- **会话列表缓存**：Redis，TTL 30 分钟
- **消息缓存**：Redis，最近 100 条消息

### 数据库优化

- **读写分离**：主库写，从库读
- **分库分表**：按用户 ID 分片
- **索引优化**：合理创建索引，避免全表扫描

### 消息队列

- **Kafka**：异步处理消息事件
- **分区策略**：按 dialog_id 分区，保证顺序
- **消费者组**：支持水平扩展

---

## 🔍 监控与运维

### 监控指标

- **服务健康**：CPU、内存、磁盘、网络
- **业务指标**：消息发送量、在线用户数、API 调用量
- **性能指标**：响应时间、吞吐量、错误率

### 日志管理

- **结构化日志**：JSON 格式，便于解析
- **日志级别**：DEBUG、INFO、WARN、ERROR
- **日志聚合**：ELK Stack（Elasticsearch、Logstash、Kibana）

### 告警机制

- **服务异常告警**：服务宕机、响应超时
- **业务异常告警**：消息发送失败率过高
- **资源告警**：CPU/内存/磁盘使用率过高

---

## 🚀 扩展性设计

### 水平扩展

- **无状态服务**：BFF、核心服务都设计为无状态
- **负载均衡**：Nginx / HAProxy
- **服务发现**：Consul / Etcd

### 垂直扩展

- **数据库**：升级硬件配置
- **缓存**：增加 Redis 内存
- **消息队列**：增加 Kafka 分区

---

## 📚 参考资料

### MTProto 协议

- [Telegram API Documentation](https://core.telegram.org/api)
- [MTProto Protocol](https://core.telegram.org/mtproto)

### Teamgram Gateway

- [Teamgram Server](https://github.com/teamgram/teamgram-server)
- 仅参考其 MTProto 实现，不复制业务逻辑

---

## 📄 版本历史

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| 1.0.0 | 2026-02-03 | 初始版本，定义 Echo Server 系统架构 |

---

**最后更新**: 2026-02-03  
**维护者**: Echo 项目团队  
**状态**: 生效中 ✅
