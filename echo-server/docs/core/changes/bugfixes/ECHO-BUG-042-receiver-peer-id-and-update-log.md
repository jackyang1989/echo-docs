# [ECHO-BUG-042] æ¥æ”¶æ–¹ updateNewMessage çš„ peer_id é”™è¯¯å¯¼è‡´æ¶ˆæ¯ä¸å¯è§/æ–¹å‘å¼‚å¸¸

**çŠ¶æ€**: ğŸŸ¡ å·²å®ç°ï¼ˆå¾…éªŒæ”¶ï¼‰  
**ä¼˜å…ˆçº§**: P0ï¼ˆå½±å“ç§èŠæ¶ˆæ¯å¯è§æ€§ä¸æ–¹å‘ï¼‰  
**æ—¥æœŸ**: 2026-02-06  
**ä½œè€…**: AI Agent (Codex)

## ğŸ›‘ èƒŒæ™¯ä¸ç°è±¡

- ç§èŠæ¶ˆæ¯åœ¨æ¥æ”¶æ–¹â€œçœ‹ä¸åˆ°/ä¸åˆ·æ–°/æ–¹å‘å¼‚å¸¸â€ã€‚
- å¤ç°æ—¶ï¼šå‘é€æ–¹æ¶ˆæ¯æ­£å¸¸å…¥åº“ï¼Œä½†æ¥æ”¶æ–¹ chat é‡Œä¸å‡ºç°æˆ–æ˜¾ç¤ºåœ¨é”™è¯¯ä¼šè¯ã€‚
- è¯Šæ–­å‘ç°ï¼š`update_log` ä¸­æ¥æ”¶æ–¹çš„ `updateNewMessage` çš„ `peer_id` è¢«å†™æˆäº† **æ¥æ”¶è€…è‡ªå·±**ï¼Œå¯¼è‡´å®¢æˆ·ç«¯æ— æ³•å°†æ›´æ–°å½’å…¥æ­£ç¡®çš„å¯¹è¯ã€‚

## ğŸ” æ ¹å› åˆ†æ

åœ¨ `message.Service.SendMessage` ä¸­ç”Ÿæˆæ¥æ”¶æ–¹æ›´æ–°æ—¶ï¼Œè°ƒç”¨ï¼š

```
buildUpdateNewMessageBlob(msgID, fromUserID, peerID, ... out=false)
```

å…¶ä¸­ `peerID` ä¸ºæ¥æ”¶è€…è‡ªå·±ï¼ˆreceiverï¼‰ï¼Œè€Œ **æ­£ç¡®è¯­ä¹‰** åº”è¯¥æ˜¯ï¼š
- å‘é€ç»™æ¥æ”¶æ–¹çš„ `updateNewMessage`ï¼Œå…¶ `peer_id` å¿…é¡»æ˜¯ã€Œå¯¹è¯å¯¹è±¡ã€= å‘é€è€… `fromUserID`ã€‚

é”™è¯¯å†™å…¥çš„ `peer_id` å¯¼è‡´ï¼š
- å®¢æˆ·ç«¯æ— æ³•å°†æ›´æ–°å½’å…¥ã€Œä¸å‘é€è€…çš„ç§èŠã€
- å¯¼è‡´æ¶ˆæ¯ä¸å¯è§ã€æ–¹å‘å¼‚å¸¸

## ğŸ›  ä¿®å¤æ–¹æ¡ˆ

### 1) ä¿®å¤æ¥æ”¶æ–¹ updateNewMessage çš„ peer_id

åœ¨å‘é€ç»™æ¥æ”¶æ–¹çš„æ›´æ–°ä¸­ï¼š
- å°† `peer_id` è®¾ä¸º `fromUserID`ï¼ˆå‘é€è€…ï¼‰
- ä½¿å®¢æˆ·ç«¯èƒ½å¤Ÿæ­£ç¡®å½’ç±»ç§èŠæ›´æ–°

### 2) ä¿®å¤å†å² update_log ä¸­é”™è¯¯çš„ peer_idï¼ˆä¸€æ¬¡æ€§ä¿®å¤ï¼‰

å¯¹å·²æœ‰ `update_log` æ‰§è¡Œä¸€æ¬¡æ€§ä¿®å¤ï¼š
- ä»…ä¿®å¤ `updateNewMessage` ä¸” `peer_id == user_id && from_id != user_id` çš„è®°å½•
- å°† `peer_id` æ”¹ä¸º `from_id`
- é‡æ–°ç¼–ç å†™å› `update_log`

> è¯¥ä¿®å¤æ˜¯â€œæ•°æ®ä¸€è‡´æ€§ä¿®å¤â€ï¼Œä¸æ˜¯ workaroundã€‚ä¿è¯ update_log ä½œä¸º SSOT çš„æ­£ç¡®æ€§ã€‚

## âœ… å½±å“èŒƒå›´

- `echo-server/internal/service/message/service.go`
- æ•°æ®å±‚ï¼š`update_log` è¡¨å†å²è®°å½•ï¼ˆä¸€æ¬¡æ€§ä¿®å¤ï¼‰

## ğŸ”— å…³è”å˜æ›´

- ä¿®å¤æ¥æ”¶æ–¹ `updateNewMessage.peer_id`ï¼š
  - `echo-server/internal/service/message/service.go`

## âœ… éªŒæ”¶å»ºè®®ï¼ˆç«¯åˆ°ç«¯ï¼‰

1. A â†’ B å‘é€æ¶ˆæ¯ï¼š
   - A ç«¯æ¶ˆæ¯æ˜¾ç¤ºåœ¨å³ä¾§ï¼ˆOut=trueï¼‰
   - B ç«¯æ¶ˆæ¯å‡ºç°åœ¨ä¸ A çš„å¯¹è¯ä¸­ï¼Œå¹¶æ˜¾ç¤ºåœ¨å·¦ä¾§
2. æ¸…ç©ºæ•°æ®é‡æ–°ç™»å½•åï¼Œå†å²ç§èŠæ¶ˆæ¯ä»å½’å±æ­£ç¡®å¯¹è¯
3. `update_log` ä¸­æ¥æ”¶æ–¹ `updateNewMessage.peer_id` ä¸å†ç­‰äºè‡ªèº«

## ğŸ“œ æƒå¨çº¦æŸåˆè§„æ€§è¯´æ˜

- **ä¸ä¿®æ”¹å®¢æˆ·ç«¯ä¸šåŠ¡é€»è¾‘** âœ…ï¼ˆä»…æœåŠ¡ç«¯ä¿®å¤ï¼‰  
- **ä¸ä½¿ç”¨ mock/stub/fake success** âœ…  
- **ä¸€è‡´æ€§æ¨¡å‹** âœ…ï¼ˆä¿®å¤ update_log å†å²é”™è¯¯ï¼Œä¿æŒ SSOT æ­£ç¡®ï¼‰
