# Echo ç¾¤æ¶ˆæ¯å­˜å‚¨å®Œæ•´æ–¹æ¡ˆï¼ˆå¯¹æ ‡ Telegram Â· å¯é•¿æœŸè¿è¥ï¼‰

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0.0  
**åˆ›å»ºæ—¥æœŸ**: 2026-02-03  
**çŠ¶æ€**: è®¾è®¡æ–¹æ¡ˆ ğŸ“‹

---

## ğŸ¯ è®¾è®¡ç›®æ ‡ï¼ˆç¡¬çº¦æŸï¼‰

### 1. ç”¨æˆ·ç›´è§‰ä¸€è‡´

**åˆ›å»ºç¾¤æ—¶**ï¼š
- é»˜è®¤"æ°¸ä¹…ä¿å­˜"
- æ— å¼¹çª—ã€æ— è­¦å‘Šã€æ— é¢å¤–è§£é‡Š

**è®¾ç½®é‡Œ**ï¼š
- å¯é€‰æ‹©æ¶ˆæ¯ä¿å­˜æœŸé™

ğŸ‘‰ **å’Œ Telegram ä¸€è‡´ï¼Œç”¨æˆ·ä¸éœ€è¦è¢«æ•™è‚²**

### 2. æˆæœ¬å¯æ§

**æ°¸ä¹… â‰  æ°¸è¿œæ— é™åˆ¶ä¿å­˜æ‰€æœ‰åª’ä½“**
- æ–‡æœ¬ã€ç»“æ„æ°¸ä¹…
- åª’ä½“åˆ†å±‚

### 3. ä¸äº§ç”ŸæŠ€æœ¯å€º

- ä¸"å…ˆå‡è£…æ”¯æŒï¼Œåé¢å†è¡¥"
- æ¯ä¸€æ¡è§„åˆ™éƒ½æ˜¯é•¿æœŸè§„åˆ™
- v0 é˜¶æ®µå¯ä»¥å…³é—­åŠŸèƒ½ï¼Œä½†ç»“æ„å¿…é¡»å®Œæ•´

---

## ğŸ’¡ Echo çš„æ ¸å¿ƒåŸåˆ™ï¼ˆä¸€å¥è¯ï¼‰

> **Echo æ°¸ä¹…ä¿å­˜çš„æ˜¯ã€Œå¯¹è¯ç»“æ„ä¸å›åº”å…³ç³»ã€ï¼Œåª’ä½“æ–‡ä»¶æ˜¯å¦é•¿æœŸå­˜åœ¨ï¼Œç”±æ˜ç¡®è§„åˆ™å’Œè´£ä»»æ–¹å†³å®šã€‚**

è¿™å¥è¯æ˜¯æ•´ä¸ªæ–¹æ¡ˆçš„åŸºçŸ³ã€‚

---

## ğŸ“‹ ç¾¤åˆ›å»ºæ—¶çš„é»˜è®¤è¡Œä¸ºï¼ˆå¿…é¡»è¿™æ ·ï¼‰

### âœ… åˆ›å»ºç¾¤çš„é»˜è®¤çŠ¶æ€

- **ç¾¤æ¶ˆæ¯ä¿å­˜æœŸé™**ï¼šæ°¸ä¹…
- **ä¸å¼¹çª—**
- **ä¸è­¦å‘Š**
- **ä¸é¢å¤–è§£é‡Š**
- **å’Œ Telegram å®Œå…¨ä¸€è‡´**

### âš ï¸ ä½†è¿™æ˜¯"é€»è¾‘æ°¸ä¹…"ï¼Œä¸æ˜¯"æ— é™èµ„æºæ‰¿è¯º"

---

## âš™ï¸ ç¾¤çš„ã€Œæ¶ˆæ¯ä¿å­˜æœŸé™ã€è®¾ç½®ï¼ˆä¸ Telegram å¯¹é½ï¼‰

**è·¯å¾„**ï¼šç¾¤è®¾ç½® â†’ æ¶ˆæ¯ä¿å­˜æœŸé™

**å¯é€‰é¡¹**ï¼š
- æ°¸ä¹…ï¼ˆé»˜è®¤ï¼‰
- 1 å¤©
- 7 å¤©
- 30 å¤©
- 90 å¤©
- è‡ªå®šä¹‰ï¼ˆé«˜çº§ï¼‰

### âš ï¸ å…³é”®ç‚¹

**è¿™ä¸ªè®¾ç½®åªå½±å“"åª’ä½“æ–‡ä»¶ç”Ÿå‘½å‘¨æœŸ"ï¼Œä¸å½±å“æ–‡æœ¬ç»“æ„**

---

## ğŸ—ï¸ çœŸæ­£çš„å…³é”®ï¼šEcho çš„ã€Œä¸‰å±‚å­˜å‚¨è§„åˆ™ã€

è¿™æ˜¯æ•´ä¸ªç³»ç»Ÿä¸çˆ†ç‚¸çš„æ ¸å¿ƒã€‚

### ğŸŸ¢ ç¬¬ä¸€å±‚ï¼šç»“æ„å±‚ï¼ˆæ°¸ä¹…ï¼Œå¼ºä¸€è‡´ï¼‰

**æ°¸ä¹…ä¿å­˜ï¼Œä¸å¯å…³é—­**

**åŒ…å«**ï¼š
- æ–‡æœ¬æ¶ˆæ¯å†…å®¹
- å›å¤ / å¼•ç”¨å…³ç³»ï¼ˆEcho çš„æ ¸å¿ƒï¼‰
- æ—¶é—´çº¿é¡ºåº
- è°å›åº”äº†è°
- æ¶ˆæ¯ IDã€ptsã€qts

**ç‰¹ç‚¹**ï¼š
- è¿™å±‚ â‰ˆ Echo çš„"è®°å¿†"
- æ•°æ®é‡æå°
- PostgreSQL å¯æ‰›åå¹´
- **æ°¸è¿œä¸æ¸…ç†**

---

### ğŸŸ¡ ç¬¬äºŒå±‚ï¼šåª’ä½“å±‚ï¼ˆå¯è¿‡æœŸï¼‰

**å›¾ç‰‡ / è§†é¢‘ / æ–‡ä»¶**

#### é»˜è®¤è§„åˆ™ï¼ˆæ¨èç›´æ¥ç”¨ï¼‰

| ç±»å‹ | é»˜è®¤ä¿ç•™ |
|------|---------|
| å›¾ç‰‡ | 180 å¤© |
| è§†é¢‘ | 60 å¤© |
| æ–‡ä»¶ | 30 å¤© |

#### âš ï¸ é‡è¦è¯´æ˜

**å³ä½¿ç¾¤è®¾ç½®ä¸ºã€Œæ°¸ä¹…ã€ï¼Œè¿™é‡Œä¾ç„¶éµå¾ªåª’ä½“ç”Ÿå‘½å‘¨æœŸè§„åˆ™**

ğŸ‘‰ è¿™æ˜¯ Telegram æ²¡è¯´æ¸…æ¥šã€ä½†å®é™…å­˜åœ¨çš„è§„åˆ™  
ğŸ‘‰ ä½ åªæ˜¯æŠŠå®ƒæ˜¾å¼åŒ–äº†

---

### ğŸ”µ ç¬¬ä¸‰å±‚ï¼šä¿ç®¡å±‚ï¼ˆä»˜è´¹ + æ˜¾å¼ï¼‰

**å½“åª’ä½“è¦é•¿æœŸå­˜åœ¨ï¼Œå¿…é¡»è¿›å…¥è¿™ä¸€å±‚**

#### ä¸‰ç§åˆæ³•è¿›å…¥æ–¹å¼

1. **ç¾¤å­˜å‚¨æ± **
   - ç¾¤ä¸» / ç®¡ç†å‘˜å¼€å¯
   - ç¾¤æˆå‘˜å¯èµåŠ©
   - æˆæœ¬å’Œä»·å€¼å¯¹é½

2. **å‘é€è€…ä¿ç®¡æƒ**
   - åª’ä½“"æ‰€æœ‰æƒ"å±äºå‘é€è€…
   - è¿‡æœŸå‰å¯ä¸€é”®ã€Œè½¬å…¥ä¸ªäººä¿ç®¡ã€
   - è®¡å…¥ä¸ªäººé¢åº¦

3. **Echo Plusï¼ˆä¸ªäººï¼‰**
   - æ›´é•¿é»˜è®¤åª’ä½“ä¿ç•™æœŸ
   - æ›´å¤§ä¸ªäººä¿ç®¡ç©ºé—´
   - ä¸å½±å“ç¾¤è§„åˆ™

---

## ğŸ¨ åª’ä½“è¿‡æœŸåçš„è¡¨ç°ï¼ˆéå¸¸é‡è¦ï¼‰

### âŒ ç¦æ­¢

- ç›´æ¥æ¶ˆå¤±
- 404 / åŠ è½½å¤±è´¥

### âœ… æ­£ç¡®åšæ³•ï¼šå ä½ç¬¦ï¼ˆEcho æ ‡å‡†ï¼‰

#### ç¤ºä¾‹ UI æ–‡æ¡ˆ

```
ğŸ“¼ è¯¥è§†é¢‘å·²è¿‡æœŸ
å‘é€äº 2026-03-14
ç”±ç¾¤ä¸» / å‘é€è€…å†³å®šæ˜¯å¦ç»­å­˜

æŒ‰é’®ï¼ˆæƒé™æ§åˆ¶ï¼‰ï¼š
ã€ç»­å­˜ 30 å¤©ã€‘
ã€è½¬å…¥ä¸ªäººä¿ç®¡ã€‘
ã€ç¾¤å­˜å‚¨æ± ç»­å­˜ã€‘
```

ğŸ‘‰ **æ¶ˆæ¯è¿˜åœ¨ï¼Œå›å“è¿˜åœ¨ï¼Œåªæ˜¯åª’ä½“ä¸åœ¨**

---

## ğŸ‘¥ è°ä¸º"é•¿æœŸåª’ä½“"è´Ÿè´£ï¼Ÿï¼ˆæˆæœ¬åˆ†æ‘Šå…³é”®ï¼‰

Echo å¿…é¡»æ˜ç¡®è´£ä»»ä¸»ä½“ã€‚

### æ–¹æ¡ˆ Aï¼šç¾¤å­˜å‚¨æ± ï¼ˆæœ€é‡è¦ï¼‰â­â­â­

**ç¾¤ = æˆæœ¬å•ä½**

**æœºåˆ¶**ï¼š
- æ¯ä¸ªç¾¤æœ‰ä¸€ä¸ªã€Œåª’ä½“æ± ã€
- ç¾¤ä¸» / ç®¡ç†å‘˜å¯å¼€å¯
- ç¾¤æˆå‘˜å¯èµåŠ©

**ç”¨é€”**ï¼š
- ç¾¤å†…é‡è¦è§†é¢‘é•¿æœŸä¿ç•™
- è¯¾ç¨‹ç¾¤ / é¡¹ç›®ç¾¤ / ç¤¾åŒºç¾¤

**ä¼˜åŠ¿**ï¼š
- ğŸ‘‰ æˆæœ¬å’Œä»·å€¼å¯¹é½
- ğŸ‘‰ éå¸¸ç¬¦åˆ Telegram ç¾¤ä½¿ç”¨ä¹ æƒ¯

---

### æ–¹æ¡ˆ Bï¼šå‘é€è€…ä¿ç®¡æƒ

**åª’ä½“çš„"æ‰€æœ‰æƒ"å±äºå‘é€è€…**

**æœºåˆ¶**ï¼š
- åœ¨è¿‡æœŸå‰å¯ä¸€é”®ã€Œè½¬å…¥ä¸ªäººä¿ç®¡ã€
- è½¬å…¥å³è®¡å…¥ä¸ªäººé¢åº¦

**é€‚åˆ**ï¼š
- ç§èŠ
- å†…å®¹åˆ›ä½œè€…è‡ªå·±çš„é‡è¦èµ„æ–™

---

### æ–¹æ¡ˆ Cï¼šEcho Plusï¼ˆä¸ªäººï¼‰

**ä¸ªäººè®¢é˜…æœåŠ¡**

**ç‰¹æƒ**ï¼š
- æ›´é•¿é»˜è®¤åª’ä½“ä¿ç•™æœŸ
- æ›´å¤§ä¸ªäººä¿ç®¡ç©ºé—´
- ä¸å½±å“ç¾¤è§„åˆ™

---

## ğŸš€ Echo v0 å¯ç›´æ¥è½åœ°çš„æœ€å°å®ç°ï¼ˆå¯ç…§æŠ„ï¼‰

### v0 å­˜å‚¨è§„åˆ™ï¼ˆå»ºè®®é”æ­»ï¼‰

| å†…å®¹ç±»å‹ | ä¿ç•™æœŸé™ |
|---------|---------|
| æ–‡æœ¬ & Echo ç»“æ„ | æ°¸ä¹… |
| å›¾ç‰‡ | 180 å¤© |
| è§†é¢‘ | 60 å¤© |
| æ–‡ä»¶ | 30 å¤© |

### è¿‡æœŸå¤„ç†

**è¿‡æœŸ â†’ å ä½ç¬¦**

**æƒé™**ï¼š
- ç¾¤ä¸» / å‘é€è€…å¯ç»­å­˜

---

## ğŸ’­ ä½ ç°åœ¨æœ€è¯¥æ„è¯†åˆ°çš„ä¸€ä»¶äº‹

> **é•¿æœŸå­˜å‚¨ä¸æ˜¯åŠŸèƒ½é—®é¢˜ï¼Œæ˜¯äº§å“è¯šå®åº¦é—®é¢˜**

Echo ä¸éœ€è¦æ¯” Telegram æ›´"å‡æ— é™"ï¼Œè€Œæ˜¯ï¼š
- âœ… æ›´æ¸…æ™°
- âœ… æ›´å¯æ§
- âœ… æ›´å…¬å¹³

---

## ï¿½ å…³é”®è®¾è®¡åŸåˆ™ï¼ˆéå¸¸é‡è¦ï¼‰

### ä¸è¦åœ¨ v0 æŠŠåŠŸèƒ½å†™æ­»ä¸º"å¿…é¡»ä»˜è´¹"

**æ­£ç¡®åšæ³•**ï¼š

```go
if has_entitlement {
    media_retention = extended
} else {
    media_retention = default
}
```

ğŸ‘‰ **æ”¯ä»˜åªæ˜¯æ”¹å˜å‚æ•°ï¼Œä¸æ˜¯è§£é”é€»è¾‘**

---

## ğŸ’° Echo çš„æ­£ç¡®æ”¯ä»˜ç­–ç•¥ï¼šä¸‰é˜¶æ®µ

æ¯ä¸€é˜¶æ®µéƒ½ä¸æ¨ç¿»å‰ä¸€é˜¶æ®µï¼Œä¸ä¼šäº§ç”ŸæŠ€æœ¯å€ºã€‚

### ğŸŸ¢ Phase 0ï¼ˆv0ï¼‰ï¼šæ— æ”¯ä»˜ä¹Ÿèƒ½è·‘

**æ ¸å¿ƒç­–ç•¥**ï¼šå…ˆæŠŠ"å¯è®¡è´¹ç»“æ„"åšå‡ºæ¥ï¼Œä½†ä¸ä¸€å®šç«‹åˆ»æ”¶è´¹

#### ä½ ç°åœ¨å¿…é¡»å®ç°çš„

**ä¸æ˜¯æ”¯ä»˜ï¼Œè€Œæ˜¯**ï¼š
- ç¾¤å­˜å‚¨æ± ï¼ˆå®¹é‡å­—æ®µï¼‰
- åª’ä½“ç”Ÿå‘½å‘¨æœŸï¼ˆå¯ç»­å­˜ï¼‰
- ä¸ªäººä¿ç®¡é¢åº¦
- "éœ€è¦ç»­å­˜"çš„ UX æµç¨‹

ğŸ‘‰ **å³ä½¿æ²¡æœ‰æ”¯ä»˜ï¼Œç³»ç»Ÿæ˜¯å®Œæ•´çš„**

#### v0 çš„"æ›¿ä»£æ–¹å¼"

- ç¾¤ä¸»æ‰‹åŠ¨æ§åˆ¶ï¼ˆæ¸…ç† / ä¸æ¸…ç†ï¼‰
- ç®¡ç†å‘˜ whitelist
- "ç”³è¯·ç»­å­˜"ï¼ˆå…ˆäººå·¥ï¼‰

#### è¿™ä¸€æ­¥çš„ç›®æ ‡åªæœ‰ä¸€ä¸ª

**éªŒè¯ç”¨æˆ·æ˜¯å¦çœŸçš„åœ¨ä¹"é•¿æœŸä¿å­˜"**

---

### ğŸŸ¡ Phase 1ï¼ˆæœ€ç°å®ï¼‰ï¼šApp Store / Google Play å†…è´­

**è¿™æ˜¯å”¯ä¸€å¯¹ä¸­å›½å¼€å‘è€…å‹å¥½çš„"åˆæ³•å…¨çƒæ”¯ä»˜"**

#### é¡¹ç›®ç»“è®º

**ä¸­å›½å¼€å‘è€…**ï¼š
- âœ… å¯ä»¥æ— éœ€å¤‡æ¡ˆ
- âœ… è¦†ç›–å…¨çƒ
- âœ… å®¡æ ¸æˆæœ¬å¯æ§
- âœ… ç”¨æˆ·ä¿¡ä»»é«˜

#### æ€ä¹ˆç”¨åœ¨ Echoï¼Ÿ

**æ”¯ä»˜çš„ä¸æ˜¯"é’±"ï¼Œè€Œæ˜¯é¢åº¦ / æƒé™**

**ä¾‹å­**ï¼š
- Echo Plusï¼ˆæœˆè®¢é˜…ï¼‰
- ç¾¤å­˜å‚¨æ‰©å±•åŒ…
- ä¸ªäººä¿ç®¡ç©ºé—´

#### åˆè§„æ€§

App Store / Google Play ä¸å…³å¿ƒä½ æ˜¯ IM è¿˜æ˜¯äº‘å­˜å‚¨

**å®ƒä»¬åªå…³å¿ƒ**ï¼š"è¿™æ˜¯æ•°å­—å†…å®¹ / æœåŠ¡"

**å®Œå…¨åˆè§„ã€‚**

#### ä¸­å›½ç”¨æˆ·æ€ä¹ˆä»˜é’±ï¼Ÿï¼ˆç°å®ç­”æ¡ˆï¼‰

**çŸ­æœŸç°å®**ï¼šä¸­å›½ç”¨æˆ· â‰  ä¸€å®šè¦å¾®ä¿¡ / æ”¯ä»˜å®

**å®é™…æƒ…å†µ**ï¼š
- iOS ç”¨æˆ·ï¼šApp Store å†…è´­
- Android ç”¨æˆ·ï¼šGoogle Playï¼ˆæµ·å¤–ï¼‰/ ç¬¬ä¸‰æ–¹ç‰ˆæœ¬
- æ ¸å¿ƒç”¨æˆ·ï¼šæ¥å—è®¢é˜…

ğŸ‘‰ Telegramã€Notionã€Spotify éƒ½æ˜¯è¿™ä¹ˆè¿‡æ¥çš„

---

### ğŸŸ  Phase 2ï¼ˆæœ‰ç”¨æˆ·åï¼‰ï¼šç¬¬ä¸‰æ–¹ Web æ”¯ä»˜ï¼ˆå¯é€‰ï¼‰

**ç­‰ä½ æœ‰è¿™äº›æ¡ä»¶å†è€ƒè™‘**ï¼š
- æ˜ç¡®çš„æµ·å¤–ç”¨æˆ·æ¯”ä¾‹
- ç¨³å®šæœˆæ´»
- æœ‰äººæ„¿æ„ä¸º Echo ä»˜é’±

**å¯é€‰è·¯å¾„**ï¼š
1. æµ·å¤–å£³å…¬å¸ + Stripeï¼ˆå¸¸è§äºå¾ˆå¤šé¡¹ç›®ï¼Œä½†ä¸æ˜¯ç°åœ¨ï¼‰
2. ä»£ç†å•† / Reseller æ¨¡å¼ï¼ˆåˆ«äººå¸®ä½ æ”¶é’±ï¼Œä½ ç»™ä»–åˆ†æˆï¼‰
3. ç¤¾åŒºèµåŠ© / ç¾¤ä¸»ä»£ä»˜ï¼ˆéå¸¸é€‚åˆ Echo ç¾¤å­˜å‚¨æ± ï¼‰

---

### ğŸ”µ Phase 3ï¼ˆé•¿æœŸï¼‰ï¼šç›´æ¥æ”¯ä»˜ / ä¼ä¸šæ–¹æ¡ˆ

**é€‚ç”¨åœºæ™¯**ï¼š
- ä¼ä¸šå®¢æˆ·
- å¤§å‹ç¤¾åŒº
- å†…å®¹åˆ›ä½œè€…

**æ”¯ä»˜æ–¹å¼**ï¼š
- Stripeï¼ˆå›½é™…ï¼‰
- æ”¯ä»˜å® / å¾®ä¿¡ï¼ˆå›½å†…ï¼‰
- ä¼ä¸šå¯¹å…¬è½¬è´¦

**ç‰¹ç‚¹**ï¼š
- æ›´çµæ´»çš„å®šä»·
- æ›´å¤§çš„å­˜å‚¨ç©ºé—´
- ä¸“å±æŠ€æœ¯æ”¯æŒ

---

## ğŸ“Š æ•°æ®åº“å±‚è®¾è®¡ï¼ˆv0 å®ç°ï¼‰- æ­£ç¡®ç‰ˆæœ¬

### ğŸš¨ å…³é”®è®¾è®¡åŸåˆ™ï¼ˆç”Ÿæ­»çº¿ï¼‰

**ChatGPT ä¸“å®¶å®¡æŸ¥ç»“è®º**ï¼šæ€è·¯æ­£ç¡®ï¼Œä½†éœ€è¦ 4 ä¸ªå…³é”®ä¿®æ­£

#### âŒ åŸæ–¹æ¡ˆçš„è‡´å‘½é—®é¢˜

1. **è¯­ä¹‰æ··ä¹±**ï¼š`messages.media_status` å’Œ `files.status` é‡å¤/ä¸ä¸€è‡´
2. **ç ´å pts**ï¼šè¿‡æœŸ/åˆ é™¤å¦‚æœä¸èµ° `update_log`ï¼Œä¼šç›´æ¥æŠŠ `pts/getDifference` æçƒ‚
3. **å¹¶å‘é”™è¯¯**ï¼š`storage_pool_used` åšæˆé™æ€å­—æ®µï¼ŒåæœŸä¸€å®šä¼šç®—é”™
4. **å¼•ç”¨çŸ›ç›¾**ï¼š`media_status` æ”¾ `messages` ä¸Šï¼Œè½¬å‘/å¼•ç”¨/å¤šæ¶ˆæ¯å…±äº«åŒä¸€æ–‡ä»¶æ—¶å‡ºç°çŸ›ç›¾

#### âœ… æ­£ç¡®çš„è®¾è®¡åŸåˆ™

1. **å”¯ä¸€çœŸç›¸**ï¼šæ–‡ä»¶ç”Ÿå‘½å‘¨æœŸåªæœ‰ä¸€ä¸ªçœŸç›¸æº â†’ `files` è¡¨
2. **messages åªå­˜å¼•ç”¨**ï¼šä¸å­˜çŠ¶æ€ï¼ŒçŠ¶æ€ç”± `files` å†³å®š
3. **ç»Ÿè®¡é‡å¯é‡ç®—**ï¼š`used_bytes` ç”¨å¼‚æ­¥ç»Ÿè®¡è¡¨æˆ– Redisï¼Œä¸åšå¼ºä¸€è‡´å­—æ®µ
4. **ä»»ä½•å¯è§å˜åŒ–å¿…é¡»èµ° updates**ï¼šç»•å¼€ updates ç³»ç»Ÿ = ç ´å getDifference

---

### é“å¾‹ï¼šä½ å¯ä»¥éšæ—¶æ”¹æ•°æ®åº“ï¼Œä½†ä½ ä¸èƒ½ç»•å¼€ updates ç³»ç»Ÿ

**ä»»ä½•å¯¼è‡´"å®¢æˆ·ç«¯çœ‹åˆ°å†…å®¹å˜äº†"çš„è¡Œä¸ºï¼Œéƒ½å¿…é¡»**ï¼š
1. äº§ç”Ÿ Update
2. è¿›å…¥ `update_log`ï¼ˆæˆ–ç­‰ä»·ç»“æ„ï¼‰
3. åˆ†é… pts
4. åœ¨çº¿æ¨é€ + ç¦»çº¿é  getDifference å›æ”¾

**æ°¸è¿œä¸è¦**ï¼š
- âŒ ç›´æ¥åˆ  files
- âŒ ç›´æ¥åˆ æ¶ˆæ¯
- âŒ ä¸å‘ update

---

## ğŸ“‹ æœ€ç»ˆå¯ç”¨ä¸”é•¿æœŸå¯ç»´æŠ¤çš„å­—æ®µæ–¹æ¡ˆ

### ECHO v0: Storage & Permission Model (Server Pre-embed)

**ç›®æ ‡**ï¼š
1. ä¸æ”¹å˜ MTProto/TL schema
2. DB å­—æ®µä»…æœåŠ¡ç«¯å†…éƒ¨ä½¿ç”¨
3. ä»»ä½•å¯è§å˜åŒ–å¿…é¡»èµ° updates/pts

---

### 1. Chat Storage Policyï¼ˆç¾¤å­˜å‚¨ç­–ç•¥ - å•ä¸€çœŸç›¸æºï¼‰

```sql
-- ç¾¤å­˜å‚¨ç­–ç•¥è¡¨
CREATE TABLE IF NOT EXISTS chat_storage_policy (
    chat_id             BIGINT PRIMARY KEY,
    message_ttl_seconds INT NULL,     -- NULL = æ°¸ä¹…
    media_ttl_seconds   INT NULL,     -- NULL = æ°¸ä¹…
    history_visibility  SMALLINT NOT NULL DEFAULT 0, -- 0=full, 1=limited, 2=none
    created_at          TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at          TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_chat_storage_policy_updated
    ON chat_storage_policy(updated_at);

-- è¯´æ˜ï¼š
-- 1. message_ttl_seconds: æ¶ˆæ¯ TTLï¼ˆNULL = æ°¸ä¹…ï¼‰
-- 2. media_ttl_seconds: åª’ä½“ TTLï¼ˆNULL = æ°¸ä¹…ï¼‰
-- 3. history_visibility: å†å²å¯è§æ€§ï¼ˆ0=å®Œå…¨å¯è§ï¼‰
```

---

### 2. Chat Permission Policyï¼ˆç¾¤æƒé™ç­–ç•¥ï¼‰

```sql
-- ç¾¤æƒé™ç­–ç•¥è¡¨
CREATE TABLE IF NOT EXISTS chat_permission_policy (
    chat_id             BIGINT PRIMARY KEY,
    can_send_message    BOOLEAN NOT NULL DEFAULT TRUE,
    can_send_media      BOOLEAN NOT NULL DEFAULT TRUE,
    can_view_history    BOOLEAN NOT NULL DEFAULT TRUE,
    can_export_content  BOOLEAN NOT NULL DEFAULT FALSE,
    created_at          TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at          TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- è¯´æ˜ï¼š
-- 1. can_send_message: æ˜¯å¦å¯å‘é€æ¶ˆæ¯
-- 2. can_send_media: æ˜¯å¦å¯å‘é€åª’ä½“
-- 3. can_view_history: æ˜¯å¦å¯æŸ¥çœ‹å†å²
-- 4. can_export_content: æ˜¯å¦å¯å¯¼å‡ºå†…å®¹
```

---

### 3. Chat Member Roleï¼ˆæˆå‘˜è§’è‰² - æœ€å°åŒ–ï¼‰

```sql
-- æˆå‘˜è§’è‰²è¡¨
CREATE TABLE IF NOT EXISTS chat_member_role (
    chat_id     BIGINT NOT NULL,
    user_id     BIGINT NOT NULL,
    role        SMALLINT NOT NULL DEFAULT 2,
    -- 0=owner, 1=admin, 2=member, 3=restricted, 4=readonly
    assigned_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    PRIMARY KEY (chat_id, user_id)
);

CREATE INDEX IF NOT EXISTS idx_chat_member_role_user
    ON chat_member_role(user_id);

-- è¯´æ˜ï¼š
-- 1. role: è§’è‰²ç±»å‹ï¼ˆ0=ç¾¤ä¸», 1=ç®¡ç†å‘˜, 2=æˆå‘˜, 3=å—é™, 4=åªè¯»ï¼‰
```

---

### 4. Files Lifecycleï¼ˆæ–‡ä»¶ç”Ÿå‘½å‘¨æœŸ - å”¯ä¸€çœŸç›¸æºï¼‰â­â­â­

```sql
-- files è¡¨æ–°å¢å­—æ®µï¼ˆå”¯ä¸€çœŸç›¸æºï¼‰
ALTER TABLE files
    ADD COLUMN IF NOT EXISTS expires_at TIMESTAMPTZ NULL,
    ADD COLUMN IF NOT EXISTS status SMALLINT NOT NULL DEFAULT 0,
    -- 0=active, 1=expired, 2=archived, 3=deleted
    ADD COLUMN IF NOT EXISTS preserved_by SMALLINT NULL,
    -- 1=chat_pool, 2=sender, 3=subscription
    ADD COLUMN IF NOT EXISTS preserved_at TIMESTAMPTZ NULL;

CREATE INDEX IF NOT EXISTS idx_files_status_expires
    ON files(status, expires_at);

-- è¯´æ˜ï¼š
-- 1. expires_at: è¿‡æœŸæ—¶é—´ï¼ˆNULL = æ°¸ä¸è¿‡æœŸï¼‰
-- 2. status: æ–‡ä»¶çŠ¶æ€ï¼ˆ0=æ´»è·ƒ, 1=å·²è¿‡æœŸ, 2=å·²å½’æ¡£, 3=å·²åˆ é™¤ï¼‰
-- 3. preserved_by: ä¿ç®¡æ–¹å¼ï¼ˆ1=ç¾¤å­˜å‚¨æ± , 2=å‘é€è€…, 3=è®¢é˜…ï¼‰
-- 4. preserved_at: è½¬å…¥ä¿ç®¡çš„æ—¶é—´
-- 
-- âš ï¸ å…³é”®ï¼šè¿™æ˜¯æ–‡ä»¶çŠ¶æ€çš„å”¯ä¸€çœŸç›¸æº
-- messages è¡¨ä¸å­˜å‚¨ media_statusï¼Œåªå­˜å‚¨ file_id å¼•ç”¨
```

---

### 5. Messages Reference Filesï¼ˆæ¶ˆæ¯å¼•ç”¨æ–‡ä»¶ - ä¸å­˜çŠ¶æ€ï¼‰

```sql
-- messages è¡¨æ–°å¢å­—æ®µï¼ˆåªå­˜å¼•ç”¨ï¼Œä¸å­˜çŠ¶æ€ï¼‰
ALTER TABLE messages
    ADD COLUMN IF NOT EXISTS file_id BIGINT NULL;

CREATE INDEX IF NOT EXISTS idx_messages_file_id
    ON messages(file_id);

-- å¯é€‰ï¼šé¢„è®¡ç®—çš„ TTLï¼ˆä¸æ˜¯æƒå¨æ¥æºï¼Œåªæ˜¯ç¼“å­˜ï¼‰
ALTER TABLE messages
    ADD COLUMN IF NOT EXISTS ttl_expires_at TIMESTAMPTZ NULL,
    ADD COLUMN IF NOT EXISTS deleted_at TIMESTAMPTZ NULL;

CREATE INDEX IF NOT EXISTS idx_messages_ttl_expires
    ON messages(ttl_expires_at) WHERE ttl_expires_at IS NOT NULL;

-- è¯´æ˜ï¼š
-- 1. file_id: å¼•ç”¨çš„æ–‡ä»¶ ID
-- 2. ttl_expires_at: é¢„è®¡ç®—çš„è¿‡æœŸæ—¶é—´ï¼ˆç¼“å­˜ï¼Œä¸æ˜¯æƒå¨æ¥æºï¼‰
-- 3. deleted_at: åˆ é™¤æ—¶é—´ï¼ˆè½¯åˆ é™¤ï¼‰
-- 
-- âš ï¸ å…³é”®ï¼šmessages ä¸å­˜å‚¨ media_status
-- åª’ä½“çŠ¶æ€ç”± files.status å†³å®š
-- é¿å…è½¬å‘/å¼•ç”¨æ—¶å‡ºç°çŠ¶æ€çŸ›ç›¾
```

---

### 6. Quota & Entitlementï¼ˆé…é¢ä¸æƒç›Š - é¢„åŸ‹ï¼Œv0 ä¸å¼ºåˆ¶ï¼‰

```sql
-- users è¡¨æ–°å¢å­—æ®µï¼ˆé¢„åŸ‹ï¼Œv0 ä¸å¼ºåˆ¶ï¼‰
ALTER TABLE users
    ADD COLUMN IF NOT EXISTS storage_quota_bytes BIGINT NOT NULL DEFAULT 1073741824,
    ADD COLUMN IF NOT EXISTS storage_used_bytes  BIGINT NOT NULL DEFAULT 0,
    ADD COLUMN IF NOT EXISTS entitlement_level  SMALLINT NOT NULL DEFAULT 0;
    -- 0=free, 1=plus, 2=pro...

-- è¯´æ˜ï¼š
-- 1. storage_quota_bytes: å­˜å‚¨é…é¢ï¼ˆå­—èŠ‚ï¼‰
-- 2. storage_used_bytes: å·²ä½¿ç”¨å­˜å‚¨ï¼ˆå­—èŠ‚ï¼‰- âš ï¸ ç»Ÿè®¡é‡ï¼Œå¯é‡ç®—
-- 3. entitlement_level: æƒç›Šç­‰çº§ï¼ˆ0=å…è´¹ï¼‰
-- 
-- âš ï¸ å…³é”®ï¼šstorage_used_bytes æ˜¯ç»Ÿè®¡é‡
-- ä¸è¦å½“å¼ºä¸€è‡´æ¥æºï¼Œç”¨å¼‚æ­¥ç»Ÿè®¡è¡¨æˆ– Redis
```

---

### 7. Background Jobsï¼ˆåå°ä»»åŠ¡ - é€šç”¨ï¼Œé¢å‘æœªæ¥ï¼‰

```sql
-- åå°ä»»åŠ¡è¡¨ï¼ˆé€šç”¨ï¼Œæ”¯æŒå¤šç§ä»»åŠ¡ç±»å‹ï¼‰
CREATE TABLE IF NOT EXISTS background_jobs (
    id            BIGSERIAL PRIMARY KEY,
    job_type      VARCHAR(50) NOT NULL,
    resource_type VARCHAR(50) NOT NULL,
    resource_id   BIGINT NOT NULL,
    run_at        TIMESTAMPTZ NOT NULL,
    status        SMALLINT NOT NULL DEFAULT 0,
    -- 0=pending, 1=running, 2=done, 3=failed, 4=cancelled
    attempts      INT NOT NULL DEFAULT 0,
    last_error    TEXT NULL,
    created_at    TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at    TIMESTAMPTZ NOT NULL DEFAULT now(),
    UNIQUE (job_type, resource_type, resource_id)
);

CREATE INDEX IF NOT EXISTS idx_background_jobs_run
    ON background_jobs(status, run_at);

-- è¯´æ˜ï¼š
-- 1. job_type: ä»»åŠ¡ç±»å‹ï¼ˆfile_expiration, message_cleanup, cold_storage_migrationï¼‰
-- 2. resource_type: èµ„æºç±»å‹ï¼ˆfile, message, chatï¼‰
-- 3. resource_id: èµ„æº ID
-- 4. run_at: æ‰§è¡Œæ—¶é—´
-- 5. status: ä»»åŠ¡çŠ¶æ€ï¼ˆ0=å¾…æ‰§è¡Œ, 1=æ‰§è¡Œä¸­, 2=å·²å®Œæˆ, 3=å¤±è´¥, 4=å·²å–æ¶ˆï¼‰
-- 
-- âš ï¸ å…³é”®ï¼šé€šç”¨ä»»åŠ¡è¡¨ï¼Œæ”¯æŒå¹‚ç­‰ä¸åˆ†ç‰‡
-- æœªæ¥åŠ "æ¶ˆæ¯è¿‡æœŸ""å†·å­˜è¿ç§»"ä¸éœ€è¦å†é€ è¡¨
```

---

## ğŸ¯ å®Œæ•´ SQL è„šæœ¬ï¼ˆå¯ç›´æ¥æ‰§è¡Œï¼‰

```sql
-- =====================================================
-- ECHO v0: Storage & Permission Model (Server Pre-embed)
-- Target DB: PostgreSQL
-- Version: 2.0.0
-- Created: 2026-02-03
-- 
-- Goals:
-- 1) Do NOT change MTProto/TL schema
-- 2) DB fields are internal only
-- 3) Any visible change MUST go through updates/pts
-- =====================================================

BEGIN;

-- -----------------------------------------------------
-- 1) Chat storage policy (single source for TTL rules)
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS chat_storage_policy (
    chat_id             BIGINT PRIMARY KEY,
    message_ttl_seconds INT NULL,     -- NULL = forever
    media_ttl_seconds   INT NULL,     -- NULL = forever
    history_visibility  SMALLINT NOT NULL DEFAULT 0, -- 0=full, 1=limited, 2=none
    created_at          TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at          TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_chat_storage_policy_updated
    ON chat_storage_policy(updated_at);

-- -----------------------------------------------------
-- 2) Chat permission policy (role-based gate)
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS chat_permission_policy (
    chat_id             BIGINT PRIMARY KEY,
    can_send_message    BOOLEAN NOT NULL DEFAULT TRUE,
    can_send_media      BOOLEAN NOT NULL DEFAULT TRUE,
    can_view_history    BOOLEAN NOT NULL DEFAULT TRUE,
    can_export_content  BOOLEAN NOT NULL DEFAULT FALSE,
    created_at          TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at          TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- -----------------------------------------------------
-- 3) Member roles (minimal)
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS chat_member_role (
    chat_id     BIGINT NOT NULL,
    user_id     BIGINT NOT NULL,
    role        SMALLINT NOT NULL DEFAULT 2,
    -- 0=owner, 1=admin, 2=member, 3=restricted, 4=readonly
    assigned_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    PRIMARY KEY (chat_id, user_id)
);

CREATE INDEX IF NOT EXISTS idx_chat_member_role_user
    ON chat_member_role(user_id);

-- -----------------------------------------------------
-- 4) Files lifecycle (SINGLE SOURCE OF TRUTH)
-- -----------------------------------------------------
ALTER TABLE files
    ADD COLUMN IF NOT EXISTS expires_at TIMESTAMPTZ NULL,
    ADD COLUMN IF NOT EXISTS status SMALLINT NOT NULL DEFAULT 0,
    -- 0=active, 1=expired, 2=archived, 3=deleted
    ADD COLUMN IF NOT EXISTS preserved_by SMALLINT NULL,
    -- 1=chat_pool, 2=sender, 3=subscription
    ADD COLUMN IF NOT EXISTS preserved_at TIMESTAMPTZ NULL;

CREATE INDEX IF NOT EXISTS idx_files_status_expires
    ON files(status, expires_at);

-- -----------------------------------------------------
-- 5) Messages reference files, NO media_status here
-- -----------------------------------------------------
ALTER TABLE messages
    ADD COLUMN IF NOT EXISTS file_id BIGINT NULL;

CREATE INDEX IF NOT EXISTS idx_messages_file_id
    ON messages(file_id);

-- Optional: precomputed ttl for messages (not authoritative)
ALTER TABLE messages
    ADD COLUMN IF NOT EXISTS ttl_expires_at TIMESTAMPTZ NULL,
    ADD COLUMN IF NOT EXISTS deleted_at TIMESTAMPTZ NULL;

CREATE INDEX IF NOT EXISTS idx_messages_ttl_expires
    ON messages(ttl_expires_at) WHERE ttl_expires_at IS NOT NULL;

-- -----------------------------------------------------
-- 6) Quota & entitlement (pre-embed; v0 not enforced)
-- -----------------------------------------------------
ALTER TABLE users
    ADD COLUMN IF NOT EXISTS storage_quota_bytes BIGINT NOT NULL DEFAULT 1073741824,
    ADD COLUMN IF NOT EXISTS storage_used_bytes  BIGINT NOT NULL DEFAULT 0,
    ADD COLUMN IF NOT EXISTS entitlement_level  SMALLINT NOT NULL DEFAULT 0;
    -- 0=free, 1=plus, 2=pro...

-- -----------------------------------------------------
-- 7) Background jobs (generic, future-proof)
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS background_jobs (
    id            BIGSERIAL PRIMARY KEY,
    job_type      VARCHAR(50) NOT NULL,
    resource_type VARCHAR(50) NOT NULL,
    resource_id   BIGINT NOT NULL,
    run_at        TIMESTAMPTZ NOT NULL,
    status        SMALLINT NOT NULL DEFAULT 0,
    -- 0=pending, 1=running, 2=done, 3=failed, 4=cancelled
    attempts      INT NOT NULL DEFAULT 0,
    last_error    TEXT NULL,
    created_at    TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at    TIMESTAMPTZ NOT NULL DEFAULT now(),
    UNIQUE (job_type, resource_type, resource_id)
);

CREATE INDEX IF NOT EXISTS idx_background_jobs_run
    ON background_jobs(status, run_at);

COMMIT;

-- =====================================================
-- è¯´æ˜
-- =====================================================
-- 1. æ‰€æœ‰å­—æ®µé»˜è®¤å€¼ä¿è¯ç°æœ‰é€»è¾‘ä¸å˜
-- 2. files è¡¨æ˜¯æ–‡ä»¶çŠ¶æ€çš„å”¯ä¸€çœŸç›¸æº
-- 3. messages è¡¨åªå­˜å¼•ç”¨ï¼Œä¸å­˜çŠ¶æ€
-- 4. ç»Ÿè®¡é‡ï¼ˆstorage_used_bytesï¼‰å¯é‡ç®—ï¼Œä¸åšå¼ºä¸€è‡´
-- 5. Phase 0-1 åªé¢„åŸ‹å­—æ®µï¼Œä¸å¯ç”¨æ¸…ç†é€»è¾‘
-- 6. æœªæ¥å¯ç”¨æ¸…ç†æ—¶ï¼Œå¿…é¡»èµ° updates/pts ç³»ç»Ÿ
-- =====================================================
```

---

## ğŸš¨ æœªæ¥å¯ç”¨æ¸…ç†æ—¶çš„æ­£ç¡®æµç¨‹ï¼ˆç”Ÿæ­»çº¿ï¼‰

**å½“ä½ çœŸæ­£å¯ç”¨ TTL/è¿‡æœŸæ¸…ç†æ—¶ï¼Œå¿…é¡»è¿™æ ·åš**ï¼š

### æ­¥éª¤ 1ï¼šåå° Job æ‰«æè¿‡æœŸæ–‡ä»¶

```go
func ScanExpiredFiles() {
    // 1. æ‰«æ files.expires_at <= now()
    expiredFiles := db.Query(`
        SELECT id, storage_path 
        FROM files 
        WHERE expires_at <= NOW() 
        AND status = 0
        LIMIT 1000
    `)
    
    for _, file := range expiredFiles {
        // 2. æ›´æ–°æ–‡ä»¶çŠ¶æ€
        db.Exec(`UPDATE files SET status = 1 WHERE id = ?`, file.ID)
        
        // 3. è®°å½• internal event + å®¡è®¡ï¼ˆä¸æ˜¯ TL Updateï¼Œä¸ä¸‹å‘ç»™å®¢æˆ·ç«¯ï¼‰
        EmitInternalEvent("im.media.lifecycle.expired.v1", map[string]any{"file_id": file.ID})
    }
}
```

---

### æ­¥éª¤ 2ï¼šå¯¹å¤–è¡Œä¸ºï¼ˆTL å…¼å®¹ï¼Œä¸æ–°å¢ TL Updateï¼‰

é»˜è®¤æ¨èç­–ç•¥ï¼š
- **æ¶ˆæ¯ä¿ç•™ä¸å˜**ï¼ˆä¸åˆ é™¤ã€ä¸ç¼–è¾‘ï¼‰
- **åª’ä½“æŒ‰éœ€ä¸‹è½½å¤±è´¥**ï¼ˆå®¢æˆ·ç«¯è¯·æ±‚æ–‡ä»¶æ—¶å†åˆ¤æ–­æ˜¯å¦å¯ç”¨ï¼‰

å…³é”®ç‚¹ï¼š
- `files` æ˜¯ç”Ÿå‘½å‘¨æœŸå”¯ä¸€çœŸç›¸æº
- ä¸å…è®¸ä¼ªé€  `UpdateMessageMediaExpired` ä¹‹ç±»çš„â€œè‡ªå®šä¹‰ TL Updateâ€
- æœåŠ¡ç«¯åº”ä½¿ç”¨ Telegram æ—¢æœ‰é”™è¯¯ç è¡¨è¾¾
  - `FILE_REFERENCE_EXPIRED` / `FILE_REFERENCE_EMPTY` / `FILE_REFERENCE_INVALID`ï¼ˆè§¦å‘å®¢æˆ·ç«¯åˆ·æ–° file referenceï¼‰
  - æˆ– `FILE_ID_INVALID` / `LOCATION_INVALID`ï¼ˆæ–‡ä»¶å·²ä¸å¯ç”¨/ä¸å¯å®šä½ï¼‰

å®¢æˆ·ç«¯ä¾§è¯æ®ï¼š
- Android å®¢æˆ·ç«¯ä¼šè¯†åˆ« `FILE_REFERENCE_*` é”™è¯¯å¹¶è§¦å‘åˆ·æ–°é€»è¾‘ï¼š
  - `echo-android-client/TMessagesProj/src/main/java/com/echo/messenger/FileRefController.java`ï¼ˆ`isFileRefError`ï¼‰

ä¼ªä»£ç ç¤ºä¾‹ï¼š

```go
func GetFile(fileID int64, fileReference []byte) ([]byte, error) {
    f := db.QueryRow(`SELECT status, expires_at, storage_path FROM files WHERE id = ?`, fileID)

    // 1) æ–‡ä»¶å·²è¿‡æœŸ/åˆ é™¤ï¼šè¿”å› TL å…¼å®¹é”™è¯¯ç 
    if f.Status != 0 {
        return nil, mtproto.ErrFileIdInvalid
    }

    // 2) file_reference è¿‡æœŸï¼šè¿”å› FILE_REFERENCE_EXPIRED è®©å®¢æˆ·ç«¯åˆ·æ–°
    if !IsValidFileReference(fileReference) {
        return nil, mtproto.ErrFileReferenceExpired
    }

    // 3) æ­£å¸¸è¯»å–å¯¹è±¡å­˜å‚¨
    return minio.GetObject(f.StoragePath)
}
```

---

### æ­¥éª¤ 3ï¼šå¦‚éœ€â€œå¯è§å˜åŒ–â€ï¼Œå¿…é¡»èµ° updates/pts/getDifference

å¦‚æœæœªæ¥å†³å®šè®©å®¢æˆ·ç«¯â€œä¸»åŠ¨çœ‹åˆ°å˜åŒ–â€ï¼ˆä¾‹å¦‚åˆ é™¤æ¶ˆæ¯/ç¼–è¾‘ä¸ºå ä½ç¬¦ï¼‰ï¼Œåˆ™å¿…é¡»ï¼š
- ä½¿ç”¨æ—¢æœ‰ TL æ›´æ–°æœºåˆ¶ï¼ˆä¾‹å¦‚ `updateDeleteMessages` / `updateEditMessage`ï¼‰
- å†™å…¥ `update_log`
- ä¿è¯ `getDifference` å¯å›æ”¾

é»˜è®¤ç­–ç•¥ï¼ˆä¸‹è½½å¤±è´¥ï¼‰ä¸è¦æ±‚é¢å¤– TL updateï¼Œä½†è¦æ±‚å®¡è®¡ä¸å¯è¿½æº¯ï¼ˆinternal event + logsï¼‰ã€‚

---

## ğŸ¯ æ ¸å¿ƒåŸåˆ™æ€»ç»“

### âœ… æ­£ç¡®çš„åšæ³•

1. **files è¡¨æ˜¯å”¯ä¸€çœŸç›¸æº**ï¼šæ–‡ä»¶çŠ¶æ€åªåœ¨ files è¡¨
2. **messages åªå­˜å¼•ç”¨**ï¼šä¸å­˜ media_statusï¼Œé¿å…çŸ›ç›¾
3. **ç»Ÿè®¡é‡å¯é‡ç®—**ï¼šstorage_used_bytes ç”¨å¼‚æ­¥ç»Ÿè®¡
4. **ä»»ä½•å®¢æˆ·ç«¯å¯è§å˜åŒ–èµ°æ—¢æœ‰ TL æœºåˆ¶ + å¯å›æ”¾æ—¥å¿—**ï¼šéœ€è¦æ—¶åˆ†é… ptsï¼Œå†™ update_log

### âŒ é”™è¯¯çš„åšæ³•

1. **âŒ messages å­˜ media_status**ï¼šè½¬å‘/å¼•ç”¨æ—¶çŠ¶æ€çŸ›ç›¾
2. **âŒ ç›´æ¥åˆ æ–‡ä»¶ä¸å‘ update**ï¼šç ´å getDifference
3. **âŒ storage_used åšå¼ºä¸€è‡´å­—æ®µ**ï¼šå¹¶å‘ä¸‹ä¼šæ¼‚ç§»
4. **âŒ ç»•å¼€ updates ç³»ç»Ÿ**ï¼šç¦»çº¿ç”¨æˆ·æ°¸è¿œè¡¥ä¸å›æ¥

---

## ğŸ“š å‚è€ƒèµ„æ–™

- **ChatGPT ä¸“å®¶å®¡æŸ¥**ï¼š2026-02-03
- **æ ¸å¿ƒåŸåˆ™**ï¼šå”¯ä¸€çœŸç›¸ + updates ç³»ç»Ÿ + å¯é‡ç®—ç»Ÿè®¡é‡
- **ç”Ÿæ­»çº¿**ï¼šä½ å¯ä»¥éšæ—¶æ”¹æ•°æ®åº“ï¼Œä½†ä½ ä¸èƒ½ç»•å¼€ updates ç³»ç»Ÿ

---

## ğŸ¨ å…·ä½“ UX æ–‡æ¡ˆ

### 1. åˆ›å»ºç¾¤è®¾ç½®é¡µ

**ç¾¤è®¾ç½® â†’ æ¶ˆæ¯ä¿å­˜æœŸé™**

```
æ¶ˆæ¯ä¿å­˜æœŸé™

â—‹ æ°¸ä¹…ï¼ˆæ¨èï¼‰
  æ–‡æœ¬å’Œç»“æ„æ°¸ä¹…ä¿å­˜
  åª’ä½“æ–‡ä»¶æŒ‰é»˜è®¤è§„åˆ™ä¿ç•™

â—‹ 1 å¤©
â—‹ 7 å¤©
â—‹ 30 å¤©
â—‹ 90 å¤©
â—‹ è‡ªå®šä¹‰

[äº†è§£åª’ä½“ä¿ç•™è§„åˆ™]
```

---

### 2. åª’ä½“è¿‡æœŸæç¤º

**èŠå¤©ç•Œé¢ - è¿‡æœŸåª’ä½“å ä½ç¬¦**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“¼ è¯¥è§†é¢‘å·²è¿‡æœŸ             â”‚
â”‚                             â”‚
â”‚ å‘é€äº 2026-03-14           â”‚
â”‚ ç”± @username å‘é€           â”‚
â”‚                             â”‚
â”‚ [ç»­å­˜ 30 å¤©]  [è½¬å…¥ä¸ªäººä¿ç®¡] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æƒé™æ§åˆ¶**ï¼š
- ç¾¤ä¸» / ç®¡ç†å‘˜ï¼šå¯ä½¿ç”¨ç¾¤å­˜å‚¨æ± ç»­å­˜
- å‘é€è€…ï¼šå¯è½¬å…¥ä¸ªäººä¿ç®¡
- å…¶ä»–äººï¼šåªèƒ½æŸ¥çœ‹

---

### 3. ç»­å­˜å¼¹çª—

**ç‚¹å‡»"ç»­å­˜ 30 å¤©"**

```
ç»­å­˜è¯¥è§†é¢‘

è¯¥è§†é¢‘å°†ä»ç¾¤å­˜å‚¨æ± ä¸­ç»­å­˜ 30 å¤©

ç¾¤å­˜å‚¨æ± å‰©ä½™ï¼š2.3 GB / 5 GB
è¯¥è§†é¢‘å¤§å°ï¼š45 MB

ç»­å­˜ååˆ°æœŸæ—¶é—´ï¼š2026-04-14

[å–æ¶ˆ]  [ç¡®è®¤ç»­å­˜]
```

---

### 4. è½¬å…¥ä¸ªäººä¿ç®¡

**ç‚¹å‡»"è½¬å…¥ä¸ªäººä¿ç®¡"**

```
è½¬å…¥ä¸ªäººä¿ç®¡

è¯¥è§†é¢‘å°†æ°¸ä¹…ä¿å­˜åœ¨ä½ çš„ä¸ªäººç©ºé—´

ä¸ªäººç©ºé—´å‰©ä½™ï¼š450 MB / 1 GB
è¯¥è§†é¢‘å¤§å°ï¼š45 MB

è½¬å…¥åå°†ä¸å†å ç”¨ç¾¤å­˜å‚¨æ± 

[å–æ¶ˆ]  [ç¡®è®¤è½¬å…¥]
```

---

### 5. ç¾¤å­˜å‚¨æ± ç®¡ç†ï¼ˆç¾¤ä¸» / ç®¡ç†å‘˜ï¼‰

**ç¾¤è®¾ç½® â†’ ç¾¤å­˜å‚¨æ± **

```
ç¾¤å­˜å‚¨æ± 

å½“å‰å®¹é‡ï¼š2.3 GB / 5 GB

å·²ä¿å­˜åª’ä½“ï¼š
- è§†é¢‘ï¼š12 ä¸ªï¼ˆ1.8 GBï¼‰
- å›¾ç‰‡ï¼š45 ä¸ªï¼ˆ0.5 GBï¼‰

[æ‰©å±•å®¹é‡]  [æŸ¥çœ‹è¯¦æƒ…]

æˆå‘˜è´¡çŒ®ï¼š
@alice  1 GB
@bob    2 GB
@carol  2 GB

[é‚€è¯·æˆå‘˜èµåŠ©]
```

---

## ğŸ’° æˆæœ¬æ¨¡å‹ä¼°ç®—

### åœºæ™¯ 1ï¼š100 ä¸ªç¾¤ï¼ˆå°è§„æ¨¡ï¼‰

**å‡è®¾**ï¼š
- å¹³å‡æ¯ç¾¤ 50 äºº
- æ¯å¤©æ¯ç¾¤ 10 æ¡æ¶ˆæ¯
- 30% åŒ…å«åª’ä½“ï¼ˆ3 æ¡/å¤©ï¼‰
- å¹³å‡åª’ä½“å¤§å°ï¼š2 MB

**è®¡ç®—**ï¼š
```
æ¯æ—¥æ–°å¢åª’ä½“ï¼š100 ç¾¤ Ã— 3 æ¡ Ã— 2 MB = 600 MB/å¤©
æ¯æœˆæ–°å¢ï¼š600 MB Ã— 30 = 18 GB/æœˆ

æŒ‰é»˜è®¤è§„åˆ™ï¼ˆè§†é¢‘ 60 å¤©ï¼Œå›¾ç‰‡ 180 å¤©ï¼‰ï¼š
- è§†é¢‘å­˜å‚¨å³°å€¼ï¼š600 MB Ã— 60 = 36 GB
- å›¾ç‰‡å­˜å‚¨å³°å€¼ï¼š600 MB Ã— 180 = 108 GB
- æ€»å³°å€¼ï¼š~150 GB

å­˜å‚¨æˆæœ¬ï¼ˆMinIO / S3ï¼‰ï¼š
- MinIO è‡ªå»ºï¼š~$0ï¼ˆç¡¬ä»¶æˆæœ¬ï¼‰
- AWS S3ï¼š$150/æœˆ Ã— $0.023/GB = ~$3.5/æœˆ
```

**ç»“è®º**ï¼š**æˆæœ¬æä½ï¼Œå®Œå…¨å¯æ§**

---

### åœºæ™¯ 2ï¼š1000 ä¸ªç¾¤ï¼ˆä¸­è§„æ¨¡ï¼‰

**å‡è®¾**ï¼š
- å¹³å‡æ¯ç¾¤ 100 äºº
- æ¯å¤©æ¯ç¾¤ 50 æ¡æ¶ˆæ¯
- 40% åŒ…å«åª’ä½“ï¼ˆ20 æ¡/å¤©ï¼‰
- å¹³å‡åª’ä½“å¤§å°ï¼š3 MB

**è®¡ç®—**ï¼š
```
æ¯æ—¥æ–°å¢åª’ä½“ï¼š1000 ç¾¤ Ã— 20 æ¡ Ã— 3 MB = 60 GB/å¤©
æ¯æœˆæ–°å¢ï¼š60 GB Ã— 30 = 1.8 TB/æœˆ

æŒ‰é»˜è®¤è§„åˆ™ï¼š
- è§†é¢‘å­˜å‚¨å³°å€¼ï¼š60 GB Ã— 60 = 3.6 TB
- å›¾ç‰‡å­˜å‚¨å³°å€¼ï¼š60 GB Ã— 180 = 10.8 TB
- æ€»å³°å€¼ï¼š~15 TB

å­˜å‚¨æˆæœ¬ï¼š
- MinIO è‡ªå»ºï¼š~$500/æœˆï¼ˆç¡¬ä»¶ + å¸¦å®½ï¼‰
- AWS S3ï¼š15000 GB Ã— $0.023 = ~$345/æœˆ
```

**ç»“è®º**ï¼š**éœ€è¦è€ƒè™‘æ”¶è´¹ï¼Œä½†ä»å¯æ§**

---

### åœºæ™¯ 3ï¼š10000 ä¸ªç¾¤ï¼ˆå¤§è§„æ¨¡ï¼Œè§†é¢‘ä¸ºä¸»ï¼‰

**å‡è®¾**ï¼š
- å¹³å‡æ¯ç¾¤ 200 äºº
- æ¯å¤©æ¯ç¾¤ 100 æ¡æ¶ˆæ¯
- 50% åŒ…å«åª’ä½“ï¼ˆ50 æ¡/å¤©ï¼‰
- å¹³å‡åª’ä½“å¤§å°ï¼š5 MBï¼ˆè§†é¢‘ä¸ºä¸»ï¼‰

**è®¡ç®—**ï¼š
```
æ¯æ—¥æ–°å¢åª’ä½“ï¼š10000 ç¾¤ Ã— 50 æ¡ Ã— 5 MB = 2.5 TB/å¤©
æ¯æœˆæ–°å¢ï¼š2.5 TB Ã— 30 = 75 TB/æœˆ

æŒ‰é»˜è®¤è§„åˆ™ï¼š
- è§†é¢‘å­˜å‚¨å³°å€¼ï¼š2.5 TB Ã— 60 = 150 TB
- å›¾ç‰‡å­˜å‚¨å³°å€¼ï¼š2.5 TB Ã— 180 = 450 TB
- æ€»å³°å€¼ï¼š~600 TB

å­˜å‚¨æˆæœ¬ï¼š
- MinIO è‡ªå»ºï¼š~$5000/æœˆï¼ˆç¡¬ä»¶ + å¸¦å®½ + è¿ç»´ï¼‰
- AWS S3ï¼š600000 GB Ã— $0.023 = ~$13800/æœˆ
```

**ç»“è®º**ï¼š**å¿…é¡»æ”¶è´¹ï¼Œä½†æœ‰æ˜ç¡®çš„æˆæœ¬æ¨¡å‹**

---

### æ”¶è´¹ç­–ç•¥å»ºè®®

#### v0 é˜¶æ®µï¼ˆå…è´¹ï¼‰
- æ”¯æŒ 100-1000 ä¸ªç¾¤
- æˆæœ¬ï¼š$0-500/æœˆ
- ç­–ç•¥ï¼šå¸å¼•æ—©æœŸç”¨æˆ·ï¼ŒéªŒè¯éœ€æ±‚

#### Phase 1ï¼ˆApp Store å†…è´­ï¼‰
- ç¾¤å­˜å‚¨æ‰©å±•åŒ…ï¼š$2.99/æœˆï¼ˆ5 GBï¼‰
- Echo Plusï¼š$4.99/æœˆï¼ˆ10 GB ä¸ªäººç©ºé—´ + æ›´é•¿ä¿ç•™æœŸï¼‰
- é¢„è®¡æ”¶å…¥ï¼š1000 ä»˜è´¹ç”¨æˆ· Ã— $3 = $3000/æœˆ

#### Phase 2ï¼ˆä¼ä¸šæ–¹æ¡ˆï¼‰
- ä¼ä¸šç¾¤å­˜å‚¨ï¼š$99/æœˆï¼ˆ100 GBï¼‰
- å¤§å‹ç¤¾åŒºï¼š$299/æœˆï¼ˆ500 GBï¼‰
- é¢„è®¡æ”¶å…¥ï¼š100 ä¼ä¸šå®¢æˆ· Ã— $100 = $10000/æœˆ

---

## ğŸ¯ ä½ æœ€å…³é”®çš„è®¤çŸ¥è½¬å˜ï¼ˆå¾ˆé‡è¦ï¼‰

### æ”¯ä»˜ â‰  å•†ä¸šåŒ–ç¬¬ä¸€æ­¥

**å­˜å‚¨ç»“æ„ + æƒé™æ¨¡å‹ æ‰æ˜¯**

å¦‚æœä½ ç°åœ¨å°±çº ç»“ï¼š
- ç”¨å“ªä¸ªæ”¯ä»˜å¹³å°
- æ€ä¹ˆç»•å¤‡æ¡ˆ

**é‚£è¯´æ˜äº§å“è¿˜æ²¡åˆ°é‚£ä¸€æ­¥ã€‚**

### Echo å½“å‰æœ€é‡è¦çš„æ˜¯

1. ç¾¤æ¶ˆæ¯é•¿æœŸå­˜åœ¨"é€»è¾‘æ­£ç¡®"
2. æˆæœ¬ä¸ä¼šå¤±æ§
3. ç”¨æˆ·èƒ½ç†è§£"ä¸ºä»€ä¹ˆè¦ç»­å­˜"

---

## ğŸ“‹ æ­£ç¡®çš„é˜¶æ®µé¡ºåºï¼ˆå¼ºçƒˆå»ºè®®ç…§æŠ„ï¼‰

### âœ… Phase 0ï¼ˆç°åœ¨æ­£åœ¨åšçš„ï¼Œåˆ«è¢«æ‰“æ–­ï¼‰

**ç›®æ ‡**ï¼šåè®® & çŠ¶æ€ä¸€è‡´æ€§

**ä½ ç°åœ¨åªè¯¥å…³å¿ƒè¿™å‡ ä»¶äº‹**ï¼š
- MTProto / teamgram-proto è·‘é€š
- å®¢æˆ·ç«¯èƒ½ï¼šç™»å½•ã€å‘æ¶ˆæ¯ã€æ”¶æ¶ˆæ¯
- å¤šç«¯åŒæ­¥ä¸ç‚¸ï¼ˆpts / getDifference æ­£ç¡®ï¼‰
- åª’ä½“èƒ½ï¼šä¸Šä¼ ã€ä¸‹è½½ã€æ­£ç¡®å…³è”æ¶ˆæ¯

âš ï¸ **åªè¦ getDifference æ²¡ 100% æ­£ç¡®ï¼Œä»»ä½•å•†ä¸šè®¾è®¡éƒ½æ˜¯è™šçš„**

---

### âœ… Phase 1ï¼ˆç´§æ¥ç€ï¼Œä½†ä»ç„¶ä¸åšæ”¯ä»˜ï¼‰

**ç›®æ ‡**ï¼šå­˜å‚¨ & æƒé™"å¯è®¡è´¹ç»“æ„"

**è¿™é‡Œæ˜¯å…³é”®ï¼Œä½†ä¸æ¥æ”¯ä»˜**

#### ä½ ç°åœ¨å°±åº”è¯¥åšçš„

**æ•°æ®ç»“æ„é‡Œæœ‰è¿™äº›å­—æ®µï¼ˆä½†ä¸æ”¶è´¹ï¼‰**ï¼š
- `retention_policy`
- `media_expire_at`
- `storage_quota`
- `owner_entitlement`

**ç¾¤ / é¢‘é“åˆ›å»ºæ—¶**ï¼š
- é»˜è®¤ï¼šæ°¸ä¹… or X å¤©ï¼ˆå¯é…ç½®ï¼‰
- åˆ°æœŸåï¼šè‡ªåŠ¨æ¸…ç† or å†»ç»“ï¼ˆåªè¯»ï¼‰

ğŸ‘‰ **æ³¨æ„ï¼šè¿™ä¸€æ­¥æ˜¯äº§å“èƒ½åŠ›ï¼Œä¸æ˜¯å•†ä¸šè¡Œä¸º**

#### âŒ ç°åœ¨ä¸è¯¥åšçš„äº‹ï¼ˆå¾ˆé‡è¦ï¼‰

- âŒ æ¥ Stripe / Paddle / LemonSqueezy
- âŒ ç ”ç©¶ Apple IAP ç»†èŠ‚
- âŒ çº ç»“ä¸­å›½ç”¨æˆ·æ€ä¹ˆä»˜é’±
- âŒ è®¾è®¡ä»·æ ¼è¡¨

**è¿™äº›ç°åœ¨åš = 100% æµªè´¹æ—¶é—´**

---

### ä¸ºä»€ä¹ˆä¸€å®šè¦"ç­‰è·‘é€šå†åšæ”¯ä»˜"

#### 1ï¸âƒ£ æ”¯ä»˜ä¸æ˜¯ç‹¬ç«‹æ¨¡å—

**æ”¯ä»˜ä¾èµ–äº**ï¼š
- æƒé™æ¨¡å‹æ˜¯å¦ç¨³å®š
- å­˜å‚¨ç”Ÿå‘½å‘¨æœŸæ˜¯å¦çœŸå®å­˜åœ¨
- ç”¨æˆ·æ˜¯å¦"è¢«ç—›ç‚¹æ‰“åˆ°"

**å¦‚æœä½ ç°åœ¨åšæ”¯ä»˜ï¼Œåé¢ä¸€å®šä¼š**ï¼š
- æ”¹ SKU
- æ”¹ entitlement
- æ”¹é€»è¾‘
- è¢«è‹¹æœ/Google å¡

#### 2ï¸âƒ£ Apple / Google å®¡æ ¸åªçœ‹"è¡Œä¸º"ï¼Œä¸çœ‹ä½ æœªæ¥è§„åˆ’

**ä»–ä»¬åªå…³å¿ƒä¸€ä»¶äº‹**ï¼š
- ä½ ç°åœ¨å–çš„è¿™ä¸ªä¸œè¥¿
- ç”¨æˆ·ç‚¹äº†
- ç³»ç»Ÿè¡Œä¸ºæ˜¯ä¸æ˜¯åˆç†

**è€Œä½ ç°åœ¨æ ¹æœ¬è¿˜ä¸çŸ¥é“è¦å–ä»€ä¹ˆã€‚**

---

## ğŸ¯ æ­£ç¡®çš„"æå‰å‡†å¤‡"æ–¹å¼ï¼ˆä¸å†™ä»£ç ï¼‰

ä½ ç°åœ¨å”¯ä¸€å¯ä»¥åšçš„å‡†å¤‡åªæœ‰è¿™ä¸ªï¼š

ğŸ‘‰ **å†™ä¸€ä»½ã€Œæœªæ¥å¯èƒ½æ”¶è´¹ç‚¹æ¸…å•ã€ï¼ˆä¸å®ç°ï¼‰**

**ä¾‹å¦‚**ï¼š
- ç¾¤å­˜å‚¨æ‰©å±•ï¼ˆå¯èƒ½æ”¶è´¹ï¼‰
- ä¸ªäººäº‘ç©ºé—´ï¼ˆå¯èƒ½æ”¶è´¹ï¼‰
- é«˜çº§ç¾¤æƒé™ï¼ˆå¯èƒ½æ”¶è´¹ï¼‰

**ä½†**ï¼š
- âŒ ä¸æ¥ SDK
- âŒ ä¸æš´éœ² UI
- âŒ ä¸ç»™ç”¨æˆ·é€‰æ‹©ä»˜è´¹

**åªæ˜¯è®¾è®¡å±‚é¢çš„è®¤çŸ¥å‡†å¤‡ã€‚**

---

## ğŸš¦ ç»™ä½ ä¸€ä¸ªå¯ä»¥ç›´æ¥æ‰§è¡Œçš„åˆ¤æ–­æ ‡å‡†

### ä½ ä»€ä¹ˆæ—¶å€™å¯ä»¥å¼€å§‹åšæ”¯ä»˜ï¼Ÿ

**å½“ä¸”ä»…å½“**ï¼š
1. getDifference è¿ç»­è·‘ 1-2 å‘¨æ— çŠ¶æ€é”™è¯¯
2. å¤šç«¯åŒæ—¶åœ¨çº¿ä¸ä¹±åº
3. ç¾¤é‡Œå‘ 1000+ æ¡æ¶ˆæ¯ + è§†é¢‘ä¸ä¸¢
4. ä½ è‡ªå·±æ„¿æ„æ¯å¤©ç”¨ Echo èŠå¤©

**è¿™ä¸€å¤©ä¹‹å‰ï¼Œä¸è¦ç¢°æ”¯ä»˜ä¸€è¡Œä»£ç ã€‚**

---

## ğŸ¯ ç°åœ¨è¯¥åšä»€ä¹ˆï¼ˆå®Œå…¨ä¸ç¢°å®¢æˆ·ç«¯ï¼‰

### ç»“è®ºï¼šåˆ†ä¸¤å±‚åš

#### âœ… ç°åœ¨å°±åšï¼ˆä¸æ”¹å®¢æˆ·ç«¯ã€é£é™©æä½ï¼‰

**åªåšæœåŠ¡ç«¯/æ•°æ®åº“å±‚é¢çš„"å¯è®¡è´¹ç»“æ„"ä¸"ç”Ÿå‘½å‘¨æœŸ"**

ä¹Ÿå°±æ˜¯ï¼š
- å…ˆæŠŠ"æœªæ¥ä¼šæ”¶è´¹çš„èƒ½åŠ›"å˜æˆåç«¯çš„å‚æ•°å’ŒçŠ¶æ€æœº
- å®¢æˆ·ç«¯å®Œå…¨æ— æ„Ÿ

#### âœ… ç­‰è·‘é€šåå†åšï¼ˆä¼šæ”¹å®¢æˆ·ç«¯ã€é£é™©é«˜ï¼‰

**æ‰€æœ‰éœ€è¦ UIã€æç¤ºã€è®¾ç½®å…¥å£ã€è´­ä¹°å…¥å£ã€å®¹é‡æ˜¾ç¤º çš„ä¸œè¥¿**

è¿™äº›éƒ½ç­‰ IM æ ¸å¿ƒç¨³å®šåå†æ”¹ã€‚

---

### 1) æ•°æ®åº“å…ˆåŠ "ä¸ä¼šå½±å“ç°æœ‰é€»è¾‘"çš„å­—æ®µ

**è¿™äº›å­—æ®µé»˜è®¤å€¼ä¿è¯è¡Œä¸ºä¸å˜**ï¼š

```sql
-- messages è¡¨
messages.expire_at NULL  -- NULL = æ°¸ä¸è¿‡æœŸ

-- media è¡¨
media.expire_at NULL

-- chats è¡¨
chats.retention_days INT NULL  -- NULL = æ°¸ä¹…
chats.storage_quota_bytes BIGINT NULL  -- NULL = ä¸é™

-- users è¡¨
users.entitlement_level SMALLINT DEFAULT 0  -- 0=å…è´¹
```

âœ… **è¿™äº›å­—æ®µåŠ äº†ï¼Œå®¢æˆ·ç«¯å®Œå…¨ä¸çŸ¥é“**  
âœ… **ä½ ä¹Ÿå¯ä»¥å…ˆä¸å¯ç”¨æ¸…ç†ä»»åŠ¡**

---

### 2) æœåŠ¡ç«¯å…ˆå®ç°"è®¡ç®—è§„åˆ™"ï¼Œä½†ä¸æ‰§è¡Œ"åˆ é™¤"

**å…ˆåšå‡½æ•°ï¼Œä¸åšåŠ¨ä½œ**ï¼š

```go
ComputeExpireAt(chat, message)
CanUploadMedia(user, chat, size)
GetQuotaStatus(chat)
```

âœ… **è¿™ä¸ä¼šæ”¹å˜ä»»ä½•ç°æœ‰è·¯å¾„**  
âœ… **åªæ˜¯åœ¨ä¸ºæœªæ¥å‡†å¤‡"æ­£ç¡®çš„ç»“æ„"**

---

### 3) å…ˆæ‰“ç‚¹ï¼ˆå…³é”®ï¼‰

**å³ä½¿ä¸æ”¶è´¹ï¼Œä½ ä¹Ÿè¦å…ˆçŸ¥é“**ï¼š
- å“ªäº›ç¾¤å‘è§†é¢‘æœ€å¤š
- å“ªäº›åª’ä½“æœ€å ç©ºé—´
- å•ç¾¤æ¯å¤©å¢é•¿å¤šå°‘ GB
- ç”¨æˆ·æ˜¯å¦çœŸçš„åœ¨ä¹"æ°¸ä¹…"

âœ… **è¿™ä¸€æ­¥å®Œå…¨ä¸éœ€è¦å®¢æˆ·ç«¯æ”¹åŠ¨**  
âœ… **ä½ åœ¨æœåŠ¡ç«¯å†™æ—¥å¿—/metrics å°±è¡Œ**

---

## ğŸš« ä»€ä¹ˆæ—¶å€™æ‰éœ€è¦åŠ¨å®¢æˆ·ç«¯ï¼Ÿ

**åªæœ‰å½“ä½ è¦åšè¿™äº›åŠŸèƒ½æ—¶ï¼Œæ‰å¿…é¡»æ”¹å®¢æˆ·ç«¯**ï¼š
- ç¾¤è®¾ç½®é‡Œé€‰æ‹©"æ¶ˆæ¯ä¿å­˜æœŸé™"
- ç¾¤ç©ºé—´ä½¿ç”¨æƒ…å†µå±•ç¤º
- è¶…é™åçš„æç¤ºï¼ˆ"éœ€è¦æ‰©å®¹/æ¸…ç†/å‡çº§"ï¼‰
- è´­ä¹°å…¥å£ï¼ˆIAP/è®¢é˜…ï¼‰
- åª’ä½“"å³å°†åˆ°æœŸ"çš„æ ‡è®°

**è¿™äº›å±äº Phaseï¼šäº§å“åŒ–/å•†ä¸šåŒ–ï¼Œå¿…é¡»ç­‰åè®®ä¸åŒæ­¥ç¨³å®šã€‚**

---

## ğŸ¯ ç»™ä½ ä¸€ä¸ªç¡¬æ ‡å‡†ï¼šä»€ä¹ˆæ—¶å€™å¯ä»¥å¼€å§‹äºŒæ¬¡å¼€å‘å®¢æˆ·ç«¯ï¼Ÿ

**æ»¡è¶³è¿™ 4 æ¡ï¼Œå†åŠ¨å®¢æˆ·ç«¯**ï¼š

1. ç™»å½•/å‘æ¶ˆæ¯/æ”¶æ¶ˆæ¯ç¨³å®š
2. å¤šç«¯åŒæ­¥ï¼ˆpts/getDifferenceï¼‰è¿ç»­è·‘å‡ å¤©ä¸å‡ºç°æ–­æ¡£/å›æ»š
3. åª’ä½“ä¸Šä¼ ä¸‹è½½ç¨³å®š
4. ä½ å·²ç»èƒ½ç”¨å®ƒå½“ä¸»åŠ› IMï¼ˆè‡³å°‘è‡ªå·±æ—¥å¸¸ç”¨ï¼‰

**æ²¡åˆ°è¿™ä¸€æ­¥ï¼Œä»»ä½•å®¢æˆ·ç«¯ UI æ”¹åŠ¨éƒ½å¯èƒ½æŠŠä½ ä»"åè®® bug"æ‹‰å›"UI bug + åè®® bug"çš„åŒåœ°ç‹±ã€‚**

---

## ğŸ’¡ æœ€ä½³å®è·µï¼šç°åœ¨"é¢„åŸ‹"ï¼Œä»¥å"å¼€å…³"

ä½ ç°åœ¨å°±å¯ä»¥åœ¨æœåŠ¡ç«¯åšæˆï¼š

```go
retention_enabled = false  // å…¨å±€å¼€å…³
quota_enabled = false
cleanup_job_enabled = false
```

**ç­‰è·‘é€šä»¥å**ï¼š
1. å…ˆå¼€ `retention_enabled`
2. è§‚å¯Ÿä¸€å‘¨
3. å†å¼€ `cleanup_job_enabled`
4. æœ€åæ‰å¼€æ”¶è´¹

**è¿™æ ·ä¸ä¼šè¿”å·¥ï¼Œä¹Ÿä¸ä¼šæ‰“æ–­ä¸»çº¿ã€‚**

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³æ‰§è¡Œï¼ˆæœ¬å‘¨ï¼‰- Phase 0

1. **âœ… åˆ›å»ºæœ¬æ–‡æ¡£**
   - å®Œæ•´çš„å­˜å‚¨ç­–ç•¥è®¾è®¡
   - æ•°æ®åº“ schema è®¾è®¡
   - å®æ–½åŸåˆ™å’Œé˜¶æ®µåˆ’åˆ†

2. **ğŸ“‹ åªåœ¨æœåŠ¡ç«¯ + DB åŠ å­—æ®µï¼ˆé»˜è®¤ä¸ç”Ÿæ•ˆï¼‰**
   - `media_files` è¡¨ï¼ˆexpire_at, statusï¼‰
   - `group_storage_pools` è¡¨ï¼ˆå®¹é‡å­—æ®µï¼‰
   - `user_storage_quotas` è¡¨ï¼ˆé¢åº¦å­—æ®µï¼‰
   - `media_expiration_tasks` è¡¨ï¼ˆè¿‡æœŸä»»åŠ¡ï¼‰

3. **ğŸ“‹ å†™"è®¡ç®— expire_at/quota"çš„çº¯å‡½æ•°ï¼ˆä¸åˆ æ•°æ®ï¼‰**
   - `ComputeExpireAt(chat, message)`
   - `CanUploadMedia(user, chat, size)`
   - `GetQuotaStatus(chat)`

4. **ğŸ“‹ åŠ  metrics ç»Ÿè®¡å­˜å‚¨å¢é•¿**
   - å“ªäº›ç¾¤å‘è§†é¢‘æœ€å¤š
   - å“ªäº›åª’ä½“æœ€å ç©ºé—´
   - å•ç¾¤æ¯å¤©å¢é•¿å¤šå°‘ GB

**å®¢æˆ·ç«¯ä¸€è¡Œä¸æ”¹ã€‚**

---

### çŸ­æœŸæ‰§è¡Œï¼ˆæœ¬æœˆï¼‰- Phase 1

**âš ï¸ å‰æï¼šgetDifference å·²ç»ç¨³å®šè¿è¡Œ 1-2 å‘¨**

5. **ğŸ“‹ å®ç°åª’ä½“ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆæœåŠ¡ç«¯ï¼‰**
   - åª’ä½“ä¸Šä¼ æ—¶è®¾ç½® `expires_at`
   - å®šæ—¶ä»»åŠ¡å¤„ç†è¿‡æœŸåª’ä½“ï¼ˆå…ˆä¸åˆ ï¼Œåªæ ‡è®°ï¼‰
   - æµ‹è¯•è¿‡æœŸé€»è¾‘

6. **ğŸ“‹ å®ç°ç¾¤å­˜å‚¨æ± åŠŸèƒ½ï¼ˆæœåŠ¡ç«¯ï¼‰**
   - ç¾¤ä¸»å¼€å¯ / å…³é—­å­˜å‚¨æ± 
   - å®¹é‡è®¡ç®—å’Œç»Ÿè®¡
   - ç»­å­˜åª’ä½“é€»è¾‘

7. **ğŸ“‹ å®ç°ä¸ªäººä¿ç®¡åŠŸèƒ½ï¼ˆæœåŠ¡ç«¯ï¼‰**
   - è½¬å…¥ä¸ªäººä¿ç®¡é€»è¾‘
   - ä¸ªäººç©ºé—´ç®¡ç†
   - é¢åº¦ç»Ÿè®¡

**å®¢æˆ·ç«¯ä»ç„¶ä¸æ”¹ã€‚**

---

### ä¸­æœŸæ‰§è¡Œï¼ˆä¸‹å­£åº¦ï¼‰- Phase 2

**âš ï¸ å‰æï¼šIM æ ¸å¿ƒåŠŸèƒ½å·²ç»ç¨³å®šè¿è¡Œ 30 å¤©**

8. **ğŸ“‹ å®ç° UX ç•Œé¢ï¼ˆå®¢æˆ·ç«¯ï¼‰**
   - è¿‡æœŸåª’ä½“å ä½ç¬¦
   - ç»­å­˜å¼¹çª—
   - ç¾¤å­˜å‚¨æ± ç®¡ç†é¡µ

9. **ğŸ“‹ é›†æˆ App Store / Google Play å†…è´­**
   - ç¾¤å­˜å‚¨æ‰©å±•åŒ…
   - Echo Plus è®¢é˜…
   - æ”¯ä»˜æµç¨‹

10. **ğŸ“‹ æˆæœ¬ç›‘æ§å’Œä¼˜åŒ–**
    - å­˜å‚¨ä½¿ç”¨ç»Ÿè®¡
    - æˆæœ¬é¢„è­¦
    - è‡ªåŠ¨æ¸…ç†ç­–ç•¥

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

| æ–‡æ¡£ | è¯´æ˜ |
|------|------|
| `ECHO_STORAGE_PERMISSION_MODEL.md` | å­˜å‚¨ä¸æƒé™æ¨¡å‹ï¼ˆæœåŠ¡ç«¯é¢„åŸ‹ï¼‰ |
| `ECHO_COMPLETE_DEVELOPMENT_PLAN.md` | å®Œæ•´å¼€å‘è®¡åˆ’ |
| `ECHO_DEVELOPMENT_PLAN_V2.md` | è°ƒæ•´åçš„å¼€å‘è®¡åˆ’ |
| `AGENTS.md` | AI Agent è§„èŒƒå’Œæ¶æ„é“å¾‹ |

---

**æœ€åæ›´æ–°**: 2026-02-03  
**ç»´æŠ¤è€…**: Echo é¡¹ç›®å›¢é˜Ÿ  
**çŠ¶æ€**: è®¾è®¡æ–¹æ¡ˆ ğŸ“‹  
**ç‰ˆæœ¬**: 2.0.0 - ç§»é™¤ Teamgram å¯¹é½è¯¯å¯¼ï¼Œæ˜ç¡® 100% è‡ªç ”å®šä½

---

## ğŸ¯ ä¸€å¥è¯æ€»ç»“

**Echo é€šè¿‡ä¸‰å±‚å­˜å‚¨æ¶æ„ï¼ˆç»“æ„å±‚æ°¸ä¹… + åª’ä½“å±‚å¯è¿‡æœŸ + ä¿ç®¡å±‚ä»˜è´¹ï¼‰ï¼Œåœ¨ä¿æŒç”¨æˆ·ä½“éªŒä¸€è‡´æ€§çš„åŒæ—¶ï¼Œå®ç°äº†æˆæœ¬å¯æ§ã€é•¿æœŸå¯ç»´æŠ¤çš„åª’ä½“å­˜å‚¨æ–¹æ¡ˆï¼Œä¸äº§ç”ŸæŠ€æœ¯å€ºï¼Œä¸ç‰ºç‰²äº§å“è¯šå®åº¦ã€‚**
