# Echo 项目完整开发计划总结

**文档版本**: 1.0.0  
**创建日期**: 2026-02-03  
**最后更新**: 2026-02-03  
**状态**: 生效中 ✅

---

## 📋 文档目的

本文档整合了 Echo 项目的所有开发计划、功能规划和技术文档，为开发团队提供完整的项目全景视图。

---

## 🎯 项目核心定位

### Echo 是什么？

**Echo 是一个 IM 优先（IM-first）的连接系统**

- **不是**内容驱动的社交平台（X / 微博）
- **不是**算法分发平台（抖音 / 推荐流）
- **不是**话题聚合平台（Reddit / 论坛）
- **是**人与人之间的连接工具

### 核心价值主张

1. **让人更容易建立真实、可控、可退出的连接**
2. **IM 是系统的心脏，其他功能都是辅助**
3. **广场/推荐只是连接的入口，不是目标**
4. **内容本身不是目标，连接才是**

### 设计底线

- IM Core 必须保持极度纯净
- 非 IM 功能必须旁路化
- 所有新增能力必须可关闭、可回滚
- 宁可牺牲增长效率，也不牺牲连接质量

---

## 📚 核心文档索引

### 1. 项目宪法级文档（最高优先级）⭐⭐⭐

| 文档 | 路径 | 说明 | 重要性 |
|------|------|------|--------|
| **项目宪法** | `ECHO执行方案-精简版.md` | 项目最高级别约束、架构基线、技术实施方案 | 🔴 必读 |
| **AI Agent 规则** | `AGENTS.md` | AI Agent 行为规范、品牌规则、架构铁律 | 🔴 必读 |

### 2. 功能规划文档

| 文档 | 路径 | 说明 | 状态 |
|------|------|------|------|
| **功能路线图** | `docs/planning/ECHO_FEATURE_ROADMAP.md` | 完整的 601 个 TL 对象分析，96% 功能覆盖率 | ✅ 完成 |
| **不支持功能清单** | `docs/planning/ECHO_UNSUPPORTED_FEATURES.md` | 21 个不支持的 API（4%） | ✅ 完成 |
| **开发路线图** | `docs/planning/ECHO_DEVELOPMENT_ROADMAP.md` | 分阶段开发计划（Phase 1-6） | ✅ 完成 |
| **管理后台规划** | `docs/planning/ECHO_ADMIN_PANEL.md` | 管理后台功能设计（25 项功能） | ✅ 完成 |
| **广场功能设计** | `docs/planning/ECHO_SQUARE_DESIGN.md` | 广场功能详细设计（P0-P2） | ✅ 完成 |
| **下一步操作** | `docs/planning/NEXT_STEPS.md` | 当前待办事项和操作指南 | ✅ 完成 |

### 3. 架构与技术文档

| 文档 | 路径 | 说明 | 状态 |
|------|------|------|------|
| **系统架构** | `docs/architecture/ECHO_ARCHITECTURE.md` | 系统架构设计 | ✅ 完成 |
| **设计原则** | `docs/architecture/ECHO_DESIGN_PRINCIPLES.md` | 设计原则和约束 | ✅ 完成 |
| **部署架构** | `docs/architecture/ARCHITECTURE_DEPLOYMENT.md` | 部署架构和运维 | ✅ 完成 |

### 4. 当前开发任务（Spec）

| Spec | 路径 | 说明 | 状态 |
|------|------|------|------|
| **消息投递修复** | `.kiro/specs/message-delivery-fix/` | 修复 Kafka 连接和消息投递问题 | 🔄 进行中 |
| **存储权限模型** | `.kiro/specs/storage-permission-model/` | 存储权限模型设计 | ⏳ 待开始 |
| **Agents 更新** | `.kiro/specs/agents-update-for-server-rebuild/` | Agents 更新以支持服务端重建 | ⏳ 待开始 |

---

## 🏗️ 技术架构总览

### 架构方案：混合方案（推荐）✅

```
Echo Android Client (Layer 221)
    ↓ MTProto 2.0
Echo Server (100% 自研)
    ├─ Gateway (复用 Teamgram Gateway)
    ├─ Auth Service (自研)
    ├─ User Service (自研)
    ├─ Message Service (自研)
    └─ Sync Service (自研)
    ↓ HTTP/gRPC
Echo Business Server (NestJS)
    ├─ 邮件验证（SendGrid / AWS SES）⭐ 主要方式
    ├─ 短信验证（Twilio / 阿里云）⚠️ 可选
    ├─ FCM/APNs 推送通知
    ├─ 管理后台
    └─ 数据分析
```

### 核心技术栈

| 组件 | 技术 | 说明 |
|------|------|------|
| **客户端** | Telegram 官方客户端（Layer 221） | 完全重命名为 Echo |
| **服务端** | Go + gRPC + Kafka | 100% 自研，只复用 Gateway |
| **Gateway** | Teamgram Gateway | 处理 MTProto 协议 |
| **业务层** | NestJS + TypeScript | 认证、推送、管理后台 |
| **数据库** | PostgreSQL + Redis | 消息存储 + 缓存 |
| **消息队列** | Kafka | 消息投递和同步 |
| **存储** | MinIO | 文件存储 |

### 为什么选择混合方案？

| 对比项 | 完整实现 MTProto | 混合方案（推荐）✅ |
|--------|-----------------|-------------------|
| 开发时间 | 3-6 个月 | 4-6 周（缩短 60-70%） |
| Bug 风险 | 高 | 低（降低 50%+） |
| 团队要求 | 需要协议专家 | 普通后端工程师即可 |
| 维护成本 | 高 | 低（降低 70%） |
| 调试效率 | 困难（二进制协议） | 简单（文本协议，提升 80%） |
| 性能延迟 | ~5ms | ~8-10ms（+3-5ms，可忽略） |

---

## 📅 开发时间线

### Phase 1: 基础部署（1-2 周）✅ 已完成

**目标**: 在 Mac 本地成功运行 Echo Server 和客户端

- [x] 服务器部署
- [x] 客户端编译
- [x] 连接测试
- [x] API Layer 兼容性测试

**当前状态**: ✅ 已完成，客户端可以连接服务器

---

### Phase 2: 认证系统（暂缓）⏸️ 暂不实施

**目标**: 替换固定验证码 12345，实现真实的邮件/短信验证

**当前决策**: ⏸️ **暂时不做邮箱/短信验证，继续使用固定验证码 12345**

#### 注册方式优先级（未来参考）

1. **📧 邮箱注册**（暂缓）⏸️
   - 国际通用，无地域限制
   - 成本低，易于维护
   - 服务商: SendGrid（推荐）或 AWS SES
     - SendGrid: 免费 100 封/天，易于集成
     - AWS SES: 按量付费 $0.10/1000 封，稳定可靠

2. **📱 手机号注册**（暂缓）⏸️
   - 国内（+86）: 阿里云短信
   - 国际: Twilio（支持 200+ 国家）
   - 成本较高，按需开启

#### 架构设计

```typescript
// 认证流程（邮箱为主）
Client → NestJS Proxy → Echo
         ↓
    1. 用户输入邮箱（或可选手机号）
    2. 生成真实验证码（6位数字）
    3. 发送邮件（SendGrid/AWS SES）或短信（可选）
    4. 存储到 Redis（5分钟过期）
         ↓
    5. 转发请求到 Echo（验证码改为 12345）
         ↓
    6. Echo 验证通过
         ↓
    7. NestJS 二次验证真实验证码
         ↓
    8. 返回成功，创建账号
```

#### 开发任务

- [ ] NestJS 项目搭建
- [ ] 邮件验证服务（必须实现）⭐
- [ ] 短信验证服务（可选，后期实现）⚠️
- [ ] Echo 代理服务
- [ ] 客户端修改
- [ ] 测试

**预计时间**: 2-3 周

---

### Phase 3: 推送通知（2-3 周）⏳ 待开始

**目标**: 实现离线消息推送（FCM/APNs）

#### 架构设计

```
Echo Server (新消息)
    ↓ PostgreSQL Trigger / Kafka
NestJS Message Listener
    ↓
Push Notification Service
    ├─ FCM (Android)
    ├─ APNs (iOS)
    └─ Web Push
```

#### 开发任务

- [ ] 消息监听器（Kafka Consumer）
- [ ] FCM 推送（Android）
- [ ] APNs 推送（iOS）
- [ ] 客户端集成
- [ ] 测试

**预计时间**: 2-3 周

---

### Phase 4: 管理后台（3-4 周）⏳ 待开始

**目标**: 构建 Web 管理后台

#### 功能模块（25 项功能）

**P0 核心功能（12 项）- 生存级功能**:
1. 用户管理（封禁、冻结、强制登出）
2. 风控系统（IP/设备封禁）
3. 对话管理（解散群、封禁群）
4. 文件控制（上传开关）
5. **搜索与可发现性** ⭐⭐⭐ (生存线)
6. **会话管理（强制登出）** ⭐⭐⭐ (生存线)
7. **平台隐私策略** ⭐
8. 内容治理（举报管理）
9. **推送控制** ⭐⭐⭐ (生存线)
10. **诈骗/虚假标记** ⭐
11. **消息类型控制** ⭐
12. 系统开关（紧急止血）

**P1 差异化功能（6 项）**:
13. 邀请系统
14. 权限边界
15. 系统推送
16. 数据统计
17. **验证标记（蓝V）** ⭐
18. **用户名管理** ⭐

**P2 运营扩展（7 项）**:
19-25. 圈子/标签、广场/推荐、内容聚合等

#### 技术栈

```
前端: React + Ant Design
后端: NestJS (已有)
数据库: PostgreSQL (Echo 业务数据) + PostgreSQL (Echo 数据)
```

#### 开发任务

- [ ] 搭建 React 项目
- [ ] 实现用户管理模块
- [ ] 实现对话管理模块
- [ ] 实现推送控制模块 ⭐
- [ ] 实现举报管理模块
- [ ] 实现数据分析模块
- [ ] 实现系统配置模块

**预计时间**: 3-4 周

---

### Phase 5: 广场功能（4-5 周）⏳ 待开始

**目标**: 实现广场功能（公共表达层）

#### 核心定位

```
广场 (Square)     = 公共表达层 (Public Broadcast)
群/频道 (Spaces)  = 主题空间 (Themed Spaces)
私聊 (IM)         = 私密关系 (Private Messaging)
```

#### 核心原则

1. **公开与私密不冲突** - 公开内容必须是"用户主动公开"
2. **群内容默认不公开** - 需要群主/频道主主动开启同步
3. **评论是"回应表达"，不是"争夺话语权"** - 单层评论，无盖楼，无热评
4. **不做曝光竞技场** - 不以粉丝数作为主要分发逻辑
5. **沉淀优先** - 核心 KPI 是收藏率、转发率、回流率，而非点赞数

#### 功能优先级

**P0 核心功能（8 项）**:
1. 个人广播发布
2. 群/频道同步发布
3. 推荐流
4. 最新流
5. 点赞/收藏/转发
6. 举报
7. Context Tag（来源标识）
8. 拉黑/屏蔽

**P1 体验增强（5 项）**:
9. 不感兴趣
10. 最新/热门切换
11. 轻评论（单层，无盖楼）⭐
12. 广场↔群回流
13. 个人页

**P2 规模化（4 项）**:
14. 多语言/地区化推荐
15. 创作者工具
16. 高级治理
17. 高级发现

#### 推荐算法设计（部分参考x平台最新开源算法）

**Phase 0 (P0)**: 规则推荐
- 候选集（in-network / out-of-network）
- 过滤（黑名单、风控、去重）
- 评分（线性可解释）
- 选取（TopK + 多样性）

**Phase 1 (P1)**: 轻量学习
- 价值预测（收藏、转发、停留）
- 回流预测（入群点击、成功）
- 风险预测（举报、拉黑、垃圾）

**Phase 2 (P2)**: 大模型
- 两塔召回
- 复杂排序器

#### 开发任务

- [ ] 数据库设计
- [ ] 后端 API 开发
- [ ] 前端基础组件
- [ ] 发布功能
- [ ] 信息流功能
- [ ] 互动功能
- [ ] 评论功能
- [ ] 推荐算法

**预计时间**: 4-5 周

---

### Phase 6: VPS 部署（2-3 周）⏳ 待开始

**目标**: 部署到生产环境

#### 服务器选择

**推荐配置**:
- CPU: 4核
- 内存: 8GB
- 存储: 100GB SSD
- 带宽: 10Mbps
- 位置: 香港/新加坡

#### 部署架构

```
Nginx (负载均衡 + SSL)
    ↓
Echo Server Cluster (3节点)
    ↓
Echo Business Server (2节点)
    ↓
数据层:
  - PostgreSQL (主从复制)
  - Redis (哨兵模式)
  - MinIO (分布式存储)
  - Kafka (3节点)
```

#### 开发任务

- [ ] 购买 VPS
- [ ] 配置域名和 SSL
- [ ] 部署 Docker Swarm / Kubernetes
- [ ] 部署 Echo Server
- [ ] 部署 Echo Business Server
- [ ] 配置监控（Prometheus + Grafana）
- [ ] 配置日志（ELK Stack）
- [ ] 配置备份

**预计时间**: 2-3 周

---

## 📊 时间估算总览

| Phase | 任务 | 时间 | 状态 |
|-------|------|------|------|
| Phase 1 | 基础部署 + 测试 | 1-2周 | ✅ 已完成 |
| Phase 2 | 认证系统开发 | 2-3周 | ⏳ 待开始 |
| Phase 3 | 推送通知开发 | 2-3周 | ⏳ 待开始 |
| Phase 4 | 管理后台开发 | 3-4周 | ⏳ 待开始 |
| Phase 5 | 广场功能开发 | 4-5周 | ⏳ 待开始 |
| Phase 6 | VPS 部署 + 优化 | 2-3周 | ⏳ 待开始 |
| **总计** | | **14-20周** | **(3.5-5个月)** |

---

## 🎯 里程碑

### Milestone 1: MVP（4周）✅ 已完成
- ✅ Echo Server 运行
- ✅ 客户端可以连接
- ✅ 基础消息功能

### Milestone 2: 认证系统（7周）⏳ 待开始
- ⏳ 邮件验证（主要）
- ⏳ 短信验证（可选）
- ⏳ 真实用户注册

### Milestone 3: 推送通知（10周）⏳ 待开始
- ⏳ FCM/APNs 推送
- ⏳ 离线消息通知

### Milestone 4: 管理后台（14周）⏳ 待开始
- ⏳ 用户管理
- ⏳ 推送控制
- ⏳ 数据分析

### Milestone 5: 广场功能（19周）⏳ 待开始
- ⏳ 发布功能
- ⏳ 信息流
- ⏳ 推荐算法

### Milestone 6: 生产就绪（22周）⏳ 待开始
- ⏳ VPS 部署
- ⏳ 监控和备份
- ⏳ 性能优化

---

## 🔴 当前紧急任务

### 消息投递修复（进行中）🔄

**问题**: 消息无法从发送方投递到接收方

**根本原因**: Kafka 连接失败

**解决方案**:
1. ✅ 创建 Kafka Topics（Inbox-T, Sync-T）
2. ⏳ 修复代码中的硬编码
3. ⏳ 重启服务并验证
4. ⏳ 端到端测试

**详细文档**: `.kiro/specs/message-delivery-fix/`

**预计完成时间**: 2-3 小时

---

## 🚨 风险管理

### 高风险

1. **+86 手机号限制**
   - 风险: Telegram 可能限制 +86 号码
   - 缓解: 主推邮箱注册 ⭐

2. **客户端检测**
   - 风险: Telegram 客户端可能检测非官方服务器
   - 缓解: 使用 Echo 推荐的 Fork 版本

### 中风险

1. **性能问题**
   - 风险: 大规模用户时性能下降
   - 缓解: 提前规划集群部署

2. **数据迁移**
   - 风险: Echo 升级时 schema 变化
   - 缓解: 版本控制 + 迁移脚本

### 低风险

1. **功能缺失**
   - 风险: 缺少频道、机器人等
   - 缓解: 初期不需要

---

## 📋 功能覆盖率

### 总体统计

- **总计**: 601 个 TL 对象
- **支持**: 580 个（96%）✅
- **不支持**: 21 个（4%）❌

### 不支持功能清单（4%）

**主要原因**: Telegram 官方服务依赖、Layer 221 之后新功能

**影响**: 低 - 不影响核心 IM 功能

**重要说明**: **完全支持通过手机号搜索本服务器用户** ✅

---

## 🔒 架构铁律（必须遵守）

### 1. IM 内核不可污染（Hard Rule）

**IM 内核**（`echo-server`）**只允许**承担以下职责：
- ✅ 协议级会话管理
- ✅ 消息投递与同步
- ✅ 群/频道的协议行为
- ✅ 媒体的协议级处理
- ✅ 推送「是否发生」的触发判断

**IM 内核严禁**直接依赖、引用或包含以下业务模块或逻辑：
- ❌ 邮箱/短信注册
- ❌ 邀请码/白名单
- ❌ 广场/信息流/推荐
- ❌ 广告/商业化
- ❌ 运营配置/A/B 实验

### 2. 单向依赖原则（Hard Rule）

**业务模块对 IM 的访问权限**：
- ✅ 允许：读取 IM 事件、读取 IM 的只读视图或副本
- ❌ 禁止：直接写入 IM 的核心消息表、直接写入 IM 的会话/投递链路表

**核心原则**: **IM 不知道业务的存在，业务只能通过受控方式影响 IM**

### 3. 可降级与功能开关规范（上线门禁）

**新功能上线必须配 Feature Flag**：
- 拥有独立 Feature Flag Key
- 默认状态为「关闭」
- 至少支持：全局开关、用户白名单、客户端版本

**功能关闭后的保证**：
- **IM 聊天、消息同步必须完全不受影响**

### 4. 契约与版本化规范（长期维护核心）

**事件/接口 Schema 必须版本化**：
- IM 事件命名必须包含版本号（如：`im.message.created.v1`）
- gRPC/HTTP 接口必须体现版本
- ❌ 禁止：不升版本直接做破坏性修改

### 5. 代码变更追踪与上游兼容性规范（Hard Rule）

**任何代码变更必须**：
- 创建变更记录文档（10 个必填项）
- 添加代码注释标记（ECHO-XXX-XXX）
- 更新 CHANGELOG.md
- 编写回滚计划

---

## 🎯 核心 KPI

### 内容价值指标

- **收藏率**（高权重）: saves / views
- **转发率**: reposts / views
- **回流率**（对群内容）: joinSuccess / views
- **低举报率**（负向指标）: reports / views（越低越好）

### 平台健康指标

- **日活用户**（DAU）
- **平均会话时长**
- **次日留存率**
- **通过广场加入的新成员数**

---

## ✅ 下一步行动

### 本周（Week 1）

1. ✅ 创建完整开发计划文档
2. 🔄 修复消息投递问题（Kafka 连接）
3. ⏳ 完成端到端消息测试
4. ⏳ 开始设计认证系统

### 下周（Week 2）

5. ⏳ 搭建 NestJS 项目
6. ⏳ 实现邮件验证服务
7. ⏳ 实现 Echo 代理服务
8. ⏳ 测试认证流程

---

## 📚 参考资源

### 官方文档
- TDLib: https://core.telegram.org/tdlib
- MTProto: https://core.telegram.org/mtproto
- Telegram API: https://core.telegram.org/api
- TL Language: https://core.telegram.org/mtproto/TL

### 官方客户端源码
- Android: https://github.com/DrKLO/Telegram
- iOS: https://github.com/TelegramMessenger/Telegram-iOS
- Desktop: https://github.com/telegramdesktop/tdesktop
- TDLib: https://github.com/tdlib/td

### 参考项目
- Teamgram Server: https://github.com/teamgram/teamgram-server
- Teamgram Proto: https://github.com/teamgram/proto

### 第三方服务
- SendGrid（邮件）: https://sendgrid.com/
- AWS SES（邮件）: https://aws.amazon.com/ses/
- Twilio（短信）: https://www.twilio.com/
- 阿里云短信: https://www.aliyun.com/product/sms
- Firebase FCM: https://firebase.google.com/docs/cloud-messaging
- Apple APNs: https://developer.apple.com/documentation/usernotifications

---

## 📝 文档维护

### 文档更新规则

1. **项目宪法级文档**（`ECHO执行方案-精简版.md`、`AGENTS.md`）
   - 只有在架构级别变更时才更新
   - 需要团队讨论和批准

2. **功能规划文档**（`docs/planning/`）
   - 功能设计完成后更新
   - 保持与实际开发同步

3. **本文档**（`ECHO_COMPLETE_DEVELOPMENT_PLAN.md`）
   - 每周更新一次
   - 反映最新的开发进度和计划调整

### 文档版本历史

| 版本 | 日期 | 作者 | 变更内容 |
|------|------|------|----------|
| 1.0.0 | 2026-02-03 | AI Agent | 初始版本，整合所有开发计划 |

---

**最后更新**: 2026-02-03  
**维护者**: Echo 项目团队  
**状态**: 生效中 ✅

---

## 🎯 一句话总结

**Echo 采用混合架构方案，复用 Teamgram 的 MTProto Gateway 处理协议层，内部使用 gRPC 微服务架构实现 100% 自研业务逻辑，使用 Telegram 官方开源客户端（echo-android-client）连接自建服务端（echo-server），在选定版本基线（API Layer 221）内实现 96% 功能覆盖率（580/601 个 API），从 Day 1 把 updates/pts 当作核心业务资产设计和测试，开发周期缩短 40-50%，维护成本降低 70%，预计 3.5-5 个月完成全部开发。**
