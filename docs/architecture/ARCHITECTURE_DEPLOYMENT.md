# Echo 部署架构说明

## 🏗️ 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                         Mac 本地环境                              │
│                                                                   │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │                    Android 客户端                           │ │
│  │  ┌──────────────────────────────────────────────────────┐  │ │
│  │  │  echo-android-client/                                 │  │ │
│  │  │  - TMessagesProj/                                     │  │ │
│  │  │    - src/main/java/com/echo/messenger/               │  │ │
│  │  │      - BuildVars.java (配置服务器地址)                │  │ │
│  │  │    - jni/ (Native 代码)                               │  │ │
│  │  │    - res/ (资源文件)                                  │  │ │
│  │  └──────────────────────────────────────────────────────┘  │ │
│  │                          ↓ MTProto                          │ │
│  └────────────────────────────────────────────────────────────┘ │
│                             ↓                                    │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │                  Echo 服务端                                 │ │
│  │  ┌──────────────────────────────────────────────────────┐  │ │
│  │  │  Gateway (10443)                                      │  │ │
│  │  │  - 接收客户端连接                                      │  │ │
│  │  │  - MTProto 协议处理                                   │  │ │
│  │  └──────────────────────────────────────────────────────┘  │ │
│  │                          ↓                                   │ │
│  │  ┌──────────────────────────────────────────────────────┐  │ │
│  │  │  BFF (Backend for Frontend)                          │  │ │
│  │  │  - 业务逻辑层                                         │  │ │
│  │  │  - API 聚合                                           │  │ │
│  │  └──────────────────────────────────────────────────────┘  │ │
│  │                          ↓                                   │ │
│  │  ┌──────────────────────────────────────────────────────┐  │ │
│  │  │  核心服务                                             │  │ │
│  │  │  - Biz (业务服务)                                     │  │ │
│  │  │  - Msg (消息服务)                                     │  │ │
│  │  │  - Sync (同步服务)                                    │  │ │
│  │  │  - AuthSession (认证会话)                            │  │ │
│  │  │  - Media (媒体服务)                                   │  │ │
│  │  │  - DFS (分布式文件系统)                               │  │ │
│  │  └──────────────────────────────────────────────────────┘  │ │
│  └────────────────────────────────────────────────────────────┘ │
│                             ↓                                    │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │              基础设施 (Docker Containers)                   │ │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐      │ │
│  │  │  MySQL   │ │  Redis   │ │  Kafka   │ │   etcd   │      │ │
│  │  │  :3306   │ │  :6379   │ │  :9092   │ │  :2379   │      │ │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘      │ │
│  │  ┌──────────┐ ┌──────────┐                                 │ │
│  │  │  MinIO   │ │Zookeeper │                                 │ │
│  │  │:9000/9001│ │  :2181   │                                 │ │
│  │  └──────────┘ └──────────┘                                 │ │
│  └────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## 📦 组件说明

### 客户端层

#### Echo Android Client
- **位置**: `echo-android-client/`
- **语言**: Java/Kotlin + C/C++ (JNI)
- **功能**: 
  - 用户界面
  - MTProto 协议实现
  - 本地数据存储
  - 媒体处理
- **配置文件**: `BuildVars.java`
- **包名**: `com.echo.messenger`

### 服务端层

#### 1. Gateway (网关服务)
- **端口**: 10443
- **功能**: 
  - 接收客户端连接
  - MTProto 协议解析
  - 连接管理
  - 负载均衡

#### 2. Session (会话服务)
- **端口**: 5222
- **功能**:
  - 会话管理
  - 连接状态维护
  - 消息路由

#### 3. BFF (业务前端服务)
- **功能**:
  - API 聚合
  - 业务逻辑编排
  - 数据转换

#### 4. 核心业务服务

**Biz Service (业务服务)**
- 用户管理
- 联系人管理
- 群组管理
- 权限控制

**Msg Service (消息服务)**
- 消息发送
- 消息接收
- 消息存储
- 消息转发

**Sync Service (同步服务)**
- 多设备同步
- 状态同步
- 更新推送

**AuthSession Service (认证会话)**
- 用户认证
- 会话管理
- 验证码发送

**Media Service (媒体服务)**
- 文件上传
- 文件下载
- 媒体处理
- 缩略图生成

**DFS Service (分布式文件系统)**
- 文件存储
- 文件检索
- 文件管理

### 基础设施层

#### MySQL (数据库)
- **端口**: 3306
- **用途**: 
  - 用户数据
  - 消息数据
  - 群组数据
  - 联系人数据
- **数据库**: `echo`

#### Redis (缓存)
- **端口**: 6379
- **用途**:
  - 会话缓存
  - 热点数据缓存
  - 分布式锁
  - 消息队列

#### Kafka (消息队列)
- **端口**: 9092
- **用途**:
  - 异步消息处理
  - 事件驱动
  - 服务解耦
- **Topics**: Inbox-T, Sync-T

#### etcd (服务发现)
- **端口**: 2379, 2380
- **用途**:
  - 服务注册
  - 服务发现
  - 配置管理
  - 分布式协调

#### MinIO (对象存储)
- **端口**: 9000 (API), 9001 (Console)
- **用途**:
  - 文件存储
  - 图片存储
  - 视频存储
  - 文档存储
- **Buckets**: documents, encryptedfiles, photos, videos

#### Zookeeper (协调服务)
- **端口**: 2181
- **用途**: Kafka 依赖

## 🔄 数据流

### 消息发送流程

```
┌──────────┐
│ 客户端 A  │
└────┬─────┘
     │ 1. 发送消息 (MTProto)
     ↓
┌────────────┐
│  Gateway   │
└────┬───────┘
     │ 2. 协议解析
     ↓
┌────────────┐
│  Session   │
└────┬───────┘
     │ 3. 会话验证
     ↓
┌────────────┐
│    BFF     │
└────┬───────┘
     │ 4. 业务处理
     ↓
┌────────────┐
│    Msg     │──→ Kafka ──→ Sync
└────┬───────┘
     │ 5. 存储消息
     ↓
┌────────────┐
│   MySQL    │
└────────────┘
     │
     │ 6. 推送通知
     ↓
┌──────────┐
│ 客户端 B  │
└──────────┘
```

### 文件上传流程

```
┌──────────┐
│  客户端   │
└────┬─────┘
     │ 1. 上传文件
     ↓
┌────────────┐
│  Gateway   │
└────┬───────┘
     │ 2. 文件接收
     ↓
┌────────────┐
│   Media    │
└────┬───────┘
     │ 3. 文件处理 (压缩/转码)
     ↓
┌────────────┐
│    DFS     │
└────┬───────┘
     │ 4. 存储文件
     ↓
┌────────────┐
│   MinIO    │
└────┬───────┘
     │ 5. 返回文件 ID
     ↓
┌────────────┐
│   MySQL    │ (存储元数据)
└────────────┘
```

### 用户认证流程

```
┌──────────┐
│  客户端   │
└────┬─────┘
     │ 1. 请求验证码
     ↓
┌────────────┐
│  Gateway   │
└────┬───────┘
     │ 2. 路由请求
     ↓
┌────────────┐
│AuthSession │
└────┬───────┘
     │ 3. 生成验证码 (12345)
     ↓
┌────────────┐
│   Redis    │ (缓存验证码)
└────────────┘
     │
     │ 4. 返回验证码
     ↓
┌──────────┐
│  客户端   │
└────┬─────┘
     │ 5. 提交验证码
     ↓
┌────────────┐
│AuthSession │
└────┬───────┘
     │ 6. 验证成功
     ↓
┌────────────┐
│   MySQL    │ (创建/更新用户)
└────────────┘
```

## 🔌 端口映射

| 服务 | 容器端口 | 主机端口 | 协议 | 说明 |
|------|---------|---------|------|------|
| MySQL | 3306 | 3306 | TCP | 数据库 |
| Redis | 6379 | 6379 | TCP | 缓存 |
| etcd | 2379 | 2379 | TCP | 服务发现 |
| etcd | 2380 | 2380 | TCP | 集群通信 |
| Kafka | 9092 | 9092 | TCP | 消息队列 |
| Zookeeper | 2181 | 2181 | TCP | 协调服务 |
| MinIO API | 9000 | 9000 | HTTP | 对象存储 |
| MinIO Console | 9001 | 9001 | HTTP | 管理界面 |
| Gateway | 10443 | 10443 | TCP | 客户端连接 |
| HTTP Server | 8801 | 8801 | HTTP | HTTP API |

## 📂 目录结构

### 服务端目录

```
echo-server-source/
├── app/                          # 应用代码
│   ├── bff/                      # BFF 服务
│   ├── interface/                # 接口层
│   │   ├── gnetway/              # 网关
│   │   ├── session/              # 会话
│   │   └── httpserver/           # HTTP 服务
│   ├── messenger/                # 消息服务
│   │   ├── msg/                  # 消息处理
│   │   └── sync/                 # 同步服务
│   └── service/                  # 核心服务
│       ├── authsession/          # 认证会话
│       ├── biz/                  # 业务逻辑
│       ├── dfs/                  # 文件系统
│       ├── media/                # 媒体处理
│       ├── idgen/                # ID 生成
│       └── status/               # 状态服务
├── echod/                    # 部署目录
│   ├── bin/                      # 可执行文件
│   ├── etc/                      # 配置文件
│   ├── logs/                     # 日志文件
│   └── sql/                      # SQL 脚本
├── data/                         # Docker 数据卷
│   ├── mysql/
│   ├── redis/
│   ├── kafka/
│   ├── etcd/
│   └── minio/
├── docker-compose-env.yaml       # 依赖服务配置
├── docker-compose.yaml           # 完整服务配置
├── Makefile                      # 构建脚本
└── build.sh                      # 构建脚本
```

### 客户端目录

```
echo-android-client/
├── TMessagesProj/                # 主项目
│   ├── src/main/
│   │   ├── java/                 # Java 代码
│   │   │   └── com/echo/
│   │   │       └── messenger/
│   │   │           ├── BuildVars.java  # 配置文件
│   │   │           ├── MessagesController.java
│   │   │           └── ...
│   │   ├── jni/                  # Native 代码
│   │   │   ├── tgnet/            # 网络库
│   │   │   ├── voip/             # 音视频
│   │   │   └── ...
│   │   └── res/                  # 资源文件
│   ├── config/                   # 配置
│   │   └── release.keystore      # 签名密钥
│   ├── build.gradle              # 构建配置
│   └── google-services.json      # Firebase 配置
├── TMessagesProj_App/            # 应用模块
├── gradle/                       # Gradle 配置
└── build.gradle                  # 根构建配置
```

## 🔐 安全架构

### 数据加密

```
客户端 ←→ 服务端
   ↓         ↓
MTProto   TLS/SSL
   ↓         ↓
端到端加密  传输加密
```

### 认证流程

```
1. 客户端 → 服务端: 请求公钥
2. 服务端 → 客户端: 返回公钥
3. 客户端 → 服务端: 加密的认证请求
4. 服务端 → 客户端: 会话密钥
5. 后续通信使用会话密钥加密
```

## 🚀 扩展架构

### 水平扩展

```
                    ┌─────────────┐
                    │ Load Balancer│
                    └──────┬──────┘
                           │
        ┌──────────────────┼──────────────────┐
        ↓                  ↓                  ↓
   ┌─────────┐       ┌─────────┐       ┌─────────┐
   │Gateway 1│       │Gateway 2│       │Gateway 3│
   └────┬────┘       └────┬────┘       └────┬────┘
        │                 │                 │
        └─────────────────┼─────────────────┘
                          ↓
                    ┌──────────┐
                    │   etcd   │ (服务发现)
                    └──────────┘
```

### 高可用架构

```
┌─────────────────────────────────────────┐
│           MySQL Master-Slave            │
│  ┌──────────┐         ┌──────────┐     │
│  │  Master  │────────→│  Slave   │     │
│  └──────────┘         └──────────┘     │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│            Redis Cluster                │
│  ┌──────┐  ┌──────┐  ┌──────┐          │
│  │Node 1│  │Node 2│  │Node 3│          │
│  └──────┘  └──────┘  └──────┘          │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│            Kafka Cluster                │
│  ┌──────┐  ┌──────┐  ┌──────┐          │
│  │Broker│  │Broker│  │Broker│          │
│  │  1   │  │  2   │  │  3   │          │
│  └──────┘  └──────┘  └──────┘          │
└─────────────────────────────────────────┘
```

## 📊 监控架构

```
┌─────────────────────────────────────────┐
│              应用层                      │
│  ┌──────────────────────────────────┐   │
│  │  Echo Services               │   │
│  │  (Metrics Endpoint)              │   │
│  └────────────┬─────────────────────┘   │
└───────────────┼─────────────────────────┘
                ↓
┌─────────────────────────────────────────┐
│           监控层                         │
│  ┌──────────────────────────────────┐   │
│  │  Prometheus (指标收集)            │   │
│  └────────────┬─────────────────────┘   │
│               ↓                          │
│  ┌──────────────────────────────────┐   │
│  │  Grafana (可视化)                 │   │
│  └──────────────────────────────────┘   │
└─────────────────────────────────────────┘
                ↓
┌─────────────────────────────────────────┐
│           告警层                         │
│  ┌──────────────────────────────────┐   │
│  │  AlertManager (告警管理)          │   │
│  └──────────────────────────────────┘   │
└─────────────────────────────────────────┘
```

## 🎯 性能优化点

### 1. 数据库优化
- 索引优化
- 查询优化
- 连接池配置
- 读写分离

### 2. 缓存优化
- Redis 缓存策略
- 热点数据预加载
- 缓存失效策略
- 分布式缓存

### 3. 消息队列优化
- Kafka 分区策略
- 消费者组配置
- 批量处理
- 异步处理

### 4. 文件存储优化
- CDN 加速
- 图片压缩
- 视频转码
- 分片上传

## 📝 配置管理

### 环境变量

```bash
# 数据库配置
DB_HOST=127.0.0.1
DB_PORT=3306
DB_USER=root
DB_PASSWORD=my_root_secret
DB_NAME=echo

# Redis 配置
REDIS_HOST=127.0.0.1
REDIS_PORT=6379

# MinIO 配置
MINIO_ENDPOINT=127.0.0.1:9000
MINIO_ACCESS_KEY=minio
MINIO_SECRET_KEY=miniostorage

# Kafka 配置
KAFKA_BROKERS=127.0.0.1:9092

# etcd 配置
ETCD_ENDPOINTS=127.0.0.1:2379
```

### 配置文件

每个服务都有独立的 YAML 配置文件:
- `echod/etc/authsession.yaml`
- `echod/etc/bff.yaml`
- `echod/etc/biz.yaml`
- `echod/etc/dfs.yaml`
- `echod/etc/gnetway.yaml`
- `echod/etc/msg.yaml`
- `echod/etc/session.yaml`
- `echod/etc/sync.yaml`

---

**此架构文档帮助你理解 Echo 系统的整体结构和各组件之间的关系。** 🏗️
